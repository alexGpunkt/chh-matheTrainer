<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mathe Trainer ‚Äì BOA / BBR (Note 2 bis 1)</title>

<!-- ZENTRALER AUFGABENPOOL F√úR NOTE 2-1 -->
<script src="pool_113.js"></script>
<script src="staticDiagrams.js"></script>
<script src="diagramRenderer.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
  h1 { text-align:center; margin: 8px 0 14px; }

  #topbar { text-align:center; margin-bottom:10px; }
  button, select { padding:10px; font-size:16px; margin:4px; }

  #status { text-align:center; font-size:18px; font-weight:bold; margin-bottom:6px; }
  #progress { text-align:center; font-size:16px; margin-bottom:10px; }

  #card { max-width:820px; margin:auto; background:white; padding:25px; border-radius:10px; }
  #taskContainer { font-size:20px; margin-bottom:15px; }
  #answerArea { margin-top: 8px; }
  input { font-size:18px; padding:5px; width:220px; }
  #feedback { margin-top:10px; font-size:18px; font-weight:bold; }

  #solution { display:none; background:#eef6ff; padding:15px; border-radius:5px; margin-top:15px; }

  /* Diagramm-Container */
  .diagram-container {
    margin: 20px 0;
    padding: 10px;
    background: #fafafa;
    border-radius: 8px;
    text-align: center;
  }
  
  .diagram-container svg {
    max-width: 100%;
    height: auto;
  }

  /* Aufgaben-Container f√ºr Export */
  #aufgabenContainer {
    margin-top: 30px;
    border-top: 2px solid #1976d2;
    padding-top: 20px;
  }
  .aufgabe {
    background: #f9f9f9;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #1976d2;
    border-radius: 4px;
  }
  .loesung {
    display: none;
  }
  
  /* ===== PRINT / PDF EXPORT ===== */
  @media print {
    body { background:#fff; padding:0; }
    #topbar, #status, #progress, #card, h1 { display:none !important; }
    #printArea { display:block !important; }
  }

  #printArea { font-family: Arial, sans-serif; color:#000; padding:18mm; display:none; }
  .print-title { font-size:18pt; font-weight:bold; margin-bottom:6mm; }
  .print-meta { font-size:11pt; margin-bottom:8mm; }
  .print-line { border-bottom:1px solid #000; display:inline-block; width:70mm; height:6mm; vertical-align:bottom; margin-left:3mm; }
  .task-block { margin-bottom:8mm; padding-bottom:6mm; border-bottom:1px solid #ddd; }
  .task-head { font-weight:bold; margin-bottom:2mm; }
  .task-text { margin-bottom:4mm; }
  .work-space { height:22mm; border:1px solid #eee; background:#fafafa; }
  .page-break { page-break-before: always; break-before: page; }
  .print-diagram {
    margin: 10px 0;
    text-align: center;
  }
</style>
</head>

<body>

<h1>üéì Mathe-Trainer ‚Äì BOA / BBR (Note 2 bis 1)</h1>

<div id="topbar">
  <select id="mode" onchange="switchMode()">
    <option value="exam">Pr√ºfungsmodus (mit Eingabe)</option>
    <option value="cards">Karteikartenmodus</option>
  </select>

  <select id="categorySelect" onchange="onCategoryChange()">
    <option value="all">Alle Kategorien</option>
  </select>

  <button onclick="startRound()">üé≤ Zufallsrunde starten</button>
  <button onclick="nextTaskRandom()">‚û°Ô∏è N√§chste Aufgabe (zuf√§llig)</button>
  <button onclick="nextTaskSameType()">üîÅ Gleicher Typ</button>
  <button onclick="toggleSolution()" id="solutionBtn">üìå L√∂sung anzeigen</button>
  <button onclick="exportiereBBRPruefung()">üßæ BBR-Pr√ºfung exportieren</button>
  <button onclick="exportiereBOAPruefung()">üìò BOA-Pr√ºfung exportieren</button>
  <button onclick="resetTrainer()">üîÑ Reset</button>
</div>

<div id="status">Punkte: 0</div>
<div id="progress">Noch keine Runde gestartet.</div>

<div id="card">
  <div id="taskContainer">Starte eine Zufallsrunde.</div>

  <div id="answerArea">
    Deine Antwort:
    <input type="text" id="userAnswer" />
    <button onclick="checkAnswer()">Antwort pr√ºfen</button>
  </div>

  <div id="feedback"></div>

  <div id="solution"></div>
  
  <!-- Aufgaben-Container f√ºr Export -->
  <div id="aufgabenContainer"></div>
</div>

<div id="printArea" style="display:none;"></div>

<script>
/* =========================================================
   12.2.html - Mathe Trainer f√ºr Note 2-1
   Verwendet pool_113.js f√ºr anspruchsvolle Aufgaben
========================================================= */

/* =========================================================
   STATE
========================================================= */
let currentAnswer = null;
let currentTask = null;
let points = 0;

let roundActive = false;
let taskNumber = 0;
let totalTasks = 10;

let solvedCurrent = false;
let lastCategory = null;
let lastGenIndex = null;

let revealed = false;

// Gespeicherte Aufgaben f√ºr Export
let exportedTasks = [];

// Verf√ºgbare Kategorien aus pool_113.js
let availableCategories = [];

/* =========================================================
   HILFSFUNKTIONEN
========================================================= */
function rand(min, max) { 
  return Math.floor(Math.random() * (max - min + 1)) + min; 
}

function getMode() { return document.getElementById("mode").value; }
function getSelectedCategory() { return document.getElementById("categorySelect").value; }

function fmt(n) {
  if (typeof n === "number") {
    if (Number.isInteger(n)) return String(n);
    return (Math.round(n * 100) / 100).toString().replace(".", ",");
  }
  return String(n);
}

function formatSteps(stepLines, result) {
  if (!stepLines) return "Keine Schritt-f√ºr-Schritt-L√∂sung verf√ºgbar.";
  
  let html = "";
  if (Array.isArray(stepLines)) {
    stepLines.forEach((line, i) => {
      html += `${i + 1}. ${line}<br>`;
    });
  } else {
    html += stepLines + "<br>";
  }
  html += `<br><b>Ergebnis: ${fmt(result)}</b>`;
  return html;
}

/* Diagramm rendern */
function renderTaskDiagram(diagramData, container) {
  if (!diagramData || !container) return;
  
  const existingDiagram = container.querySelector('.diagram-container');
  if (existingDiagram) existingDiagram.remove();
  
  const diagramContainer = document.createElement('div');
  diagramContainer.className = 'diagram-container';
  
  try {
    if (typeof window.renderDiagram === 'function') {
      window.renderDiagram(diagramData, diagramContainer);
    }
    container.appendChild(diagramContainer);
  } catch (e) {
    console.error('Fehler beim Rendern des Diagramms:', e);
  }
}

/* =========================================================
   TASKPOOL AUS POOL_113.JS LADEN
========================================================= */
function initTaskPool() {
  // Pr√ºfen ob TASKPOOL_113 verf√ºgbar ist
  if (typeof window.TASKPOOL_113 === 'undefined') {
    console.error('TASKPOOL_113 nicht gefunden! pool_113.js wurde nicht korrekt geladen.');
    alert('Fehler: Aufgabenpool konnte nicht geladen werden!');
    return false;
  }
  
  // Verf√ºgbare Kategorien ermitteln
  availableCategories = Object.keys(window.TASKPOOL_113);
  console.log('Geladene Kategorien:', availableCategories);
  
  // Kategorie-Auswahl f√ºllen
  updateCategorySelect();
  
  return true;
}

function updateCategorySelect() {
  const select = document.getElementById('categorySelect');
  
  // Bestehende Optionen l√∂schen (au√üer "Alle")
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // Neue Optionen hinzuf√ºgen
  availableCategories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    
    // Kategorie-Namen formatieren
    let displayName = cat
      .replace(/_/g, ' ')
      .replace(/prozent/g, 'Prozent')
      .replace(/zuordnung/g, 'Zuordnung')
      .replace(/pythagoras/g, 'Pythagoras')
      .replace(/koerper/g, 'K√∂rper')
      .replace(/statistik/g, 'Statistik')
      .replace(/gleichungen/g, 'Gleichungen')
      .replace(/flaeche2d/g, 'Fl√§chen')
      .replace(/wahrscheinlichkeit/g, 'Wahrscheinlichkeit')
      .replace(/wachstum/g, 'Wachstum')
      .replace(/modellierung/g, '')
      .replace(/transfer/g, '')
      .replace(/sachkontext/g, '');
    
    // Mehrfache Leerzeichen entfernen und trimmen
    displayName = displayName.replace(/\s+/g, ' ').trim();
    
    // Ersten Buchstaben gro√ü
    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
    
    option.textContent = displayName;
    select.appendChild(option);
  });
}

/* =========================================================
   TASK AUS POOL HOLEN
========================================================= */
function getRandomTask() {
  let category = getSelectedCategory();
  
  // Wenn "Alle Kategorien" ausgew√§hlt, zuf√§llige Kategorie w√§hlen
  if (category === 'all' && availableCategories.length > 0) {
    category = availableCategories[rand(0, availableCategories.length - 1)];
  }
  
  // Pr√ºfen ob Kategorie existiert
  if (!window.TASKPOOL_113[category] || window.TASKPOOL_113[category].length === 0) {
    console.error('Kategorie nicht verf√ºgbar:', category);
    // Fallback: erste verf√ºgbare Kategorie
    if (availableCategories.length > 0) {
      category = availableCategories[0];
    } else {
      return null;
    }
  }
  
  // Zuf√§lligen Index w√§hlen
  const taskList = window.TASKPOOL_113[category];
  const genIndex = rand(0, taskList.length - 1);
  const taskGen = taskList[genIndex];
  
  // Aufgabe generieren
  const task = taskGen();
  
  // Metadaten speichern
  task.category = category;
  task.genIndex = genIndex;
  
  return task;
}

/* =========================================================
   TASK ANZEIGEN
========================================================= */
function drawTask(task) {
  if (!task) {
    alert('Keine Aufgabe verf√ºgbar!');
    return;
  }
  
  currentAnswer = task.answer;
  currentTask = task;
  lastCategory = task.category;
  lastGenIndex = task.genIndex;

  solvedCurrent = false;
  revealed = false;

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  
  // L√∂sung vorbereiten
  let solutionHtml = "<b>L√∂sung Schritt-f√ºr-Schritt:</b><br><br>";
  if (task.solution) {
    solutionHtml += task.solution;
  } else if (task.steps) {
    solutionHtml += formatSteps(task.steps, task.answer);
  } else {
    solutionHtml += `Ergebnis: ${fmt(task.answer)}`;
  }
  document.getElementById("solution").innerHTML = solutionHtml;
  
  // Task-Container leeren und neu bef√ºllen
  const taskContainer = document.getElementById("taskContainer");
  taskContainer.innerHTML = `<b>(${task.category})</b> ${task.task}`;
  
  // Diagramm rendern falls vorhanden
  if (task.diagram) {
    renderTaskDiagram(task.diagram, taskContainer);
  }
  
  // Aufgabe f√ºr Export speichern
  exportedTasks.push({
    category: task.category,
    task: task.task,
    answer: task.answer,
    solution: task.solution || formatSteps(task.steps, task.answer),
    diagram: task.diagram ? JSON.parse(JSON.stringify(task.diagram)) : null
  });
  
  // Aufgaben im Container rendern
  renderTasksInContainer();
}

function renderTasksInContainer() {
  const container = document.getElementById("aufgabenContainer");
  container.innerHTML = "";
  
  exportedTasks.forEach((task, index) => {
    const aufgabeDiv = document.createElement("div");
    aufgabeDiv.className = "aufgabe";
    aufgabeDiv.id = `export_aufgabe_${index}`;
    
    let diagramHtml = '';
    if (task.diagram) {
      diagramHtml = '<div class="diagram-placeholder" style="background:#f0f0f0; padding:10px; margin:10px 0; text-align:center; border:1px dashed #999;">[Diagramm]</div>';
    }
    
    const aufgabeHtml = `
      <strong>Aufgabe ${index + 1} (${task.category}):</strong>
      <div style="margin-top: 8px;">${task.task}</div>
      ${diagramHtml}
      <div class="loesung" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 3px solid #2e7d32;">
        <strong>L√∂sung:</strong> ${task.answer}<br><br>
        <strong>Rechenweg:</strong><br>${task.solution || "‚Äî"}
      </div>
    `;
    
    aufgabeDiv.innerHTML = aufgabeHtml;
    container.appendChild(aufgabeDiv);
  });
}

/* =========================================================
   RUNDEN-FUNKTIONEN
========================================================= */
function updateStatus() {
  document.getElementById("status").innerHTML = `Punkte: ${points}`;
}

function startRound() {
  points = 0;
  taskNumber = 0;
  roundActive = true;
  solvedCurrent = false;
  lastCategory = null;
  lastGenIndex = null;
  exportedTasks = [];
  
  document.getElementById("aufgabenContainer").innerHTML = "";
  updateStatus();
  nextTaskRandom();
}

function finishRound() {
  roundActive = false;
  document.getElementById("taskContainer").innerHTML = `üèÅ Runde beendet!`;
  document.getElementById("progress").innerHTML = `Endpunktzahl: ${points} Punkte`;
}

function nextTaskRandom() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  taskNumber++;

  const task = getRandomTask();
  if (task) {
    drawTask(task);
    document.getElementById("progress").innerHTML =
      `Aufgabe ${taskNumber} von ${totalTasks}`;
  } else {
    alert("Fehler beim Generieren der Aufgabe!");
    taskNumber--;
  }
}

function nextTaskSameType() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  if (lastCategory === null || lastGenIndex === null) {
    nextTaskRandom();
    return;
  }

  // Gleiche Kategorie und Index verwenden
  const taskList = window.TASKPOOL_113[lastCategory];
  if (taskList && taskList[lastGenIndex]) {
    const task = taskList[lastGenIndex]();
    task.category = lastCategory;
    task.genIndex = lastGenIndex;
    taskNumber++;
    drawTask(task);
    document.getElementById("progress").innerHTML =
      `Aufgabe ${taskNumber} von ${totalTasks} (gleicher Typ)`;
  } else {
    nextTaskRandom();
  }
}

/* =========================================================
   ANTWORT PR√úFEN
========================================================= */
function normalize(val) {
  return parseFloat(String(val).trim().replace(",", "."));
}

function checkAnswer() {
  if (getMode() === "cards") {
    document.getElementById("feedback").innerHTML = "‚ÑπÔ∏è Karteikartenmodus: Keine Eingabepr√ºfung.";
    return;
  }
  if (solvedCurrent) return;

  const input = document.getElementById("userAnswer").value.trim();
  if (input === "") {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine Antwort eingeben.";
    return;
  }

  if (typeof currentAnswer === "string") {
    const ok = input.toLowerCase() === currentAnswer.toLowerCase();
    document.getElementById("feedback").innerHTML = ok
      ? "‚úî Richtig! +3 Punkte"
      : `‚úò Falsch. Richtige L√∂sung: ${currentAnswer}`;
    if (ok) points += 3;
    solvedCurrent = true;
    updateStatus();
    return;
  }

  const userVal = normalize(input);
  if (isNaN(userVal)) {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine Zahl eingeben.";
    return;
  }

  // Toleranz f√ºr gerundete Ergebnisse
  const tolerance = 0.05;
  if (Math.abs(userVal - currentAnswer) < tolerance) {
    points += 3;
    document.getElementById("feedback").innerHTML = "‚úî Richtig! +3 Punkte";
  } else {
    document.getElementById("feedback").innerHTML = `‚úò Falsch. Richtige L√∂sung: ${fmt(currentAnswer)}`;
  }

  solvedCurrent = true;
  updateStatus();
}

/* =========================================================
   SOLUTION TOGGLE
========================================================= */
function toggleSolution() {
  const sol = document.getElementById("solution");
  const mode = getMode();

  if (mode === "cards") {
    revealed = !revealed;
    sol.style.display = revealed ? "block" : "none";
    return;
  }

  sol.style.display = (sol.style.display === "block") ? "none" : "block";
}

/* =========================================================
   MODE/UI
========================================================= */
function switchMode() {
  const mode = getMode();
  const answerArea = document.getElementById("answerArea");
  const status = document.getElementById("status");
  const btn = document.getElementById("solutionBtn");

  if (mode === "cards") {
    answerArea.style.display = "none";
    status.style.display = "none";
    btn.textContent = "üìå L√∂sung aufdecken";
  } else {
    answerArea.style.display = "block";
    status.style.display = "block";
    btn.textContent = "üìå L√∂sung anzeigen";
  }

  revealed = false;
  document.getElementById("solution").style.display = "none";
}

function onCategoryChange() {
  revealed = false;
  document.getElementById("solution").style.display = "none";
  document.getElementById("feedback").innerHTML = "";
}

/* =========================================================
   RESET
========================================================= */
function resetTrainer() {
  points = 0;
  taskNumber = 0;
  roundActive = false;
  solvedCurrent = false;
  lastCategory = null;
  lastGenIndex = null;
  revealed = false;
  exportedTasks = [];

  updateStatus();
  document.getElementById("taskContainer").innerHTML = "Starte eine Zufallsrunde.";
  document.getElementById("progress").innerHTML = "Noch keine Runde gestartet.";
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML = "";
  document.getElementById("aufgabenContainer").innerHTML = "";
}

/* =========================================================
   EXPORT-FUNKTIONEN
========================================================= */
function exportiereBBRPruefung() {
  exportierePruefungMitLevel("BBR");
}

function exportiereBOAPruefung() {
  exportierePruefungMitLevel("BOA");
}

function exportierePruefungMitLevel(level) {
  if (exportedTasks.length === 0) {
    alert("Keine Aufgaben vorhanden. Bitte zuerst eine Zufallsrunde starten.");
    return;
  }

  const win = window.open("", "_blank");
  const titel = level === "BBR" 
    ? "Vergleichende Arbeit ‚Äì Mathematik (BBR) - Anspruchsvolles Niveau" 
    : "Vergleichende Arbeit ‚Äì Mathematik (BOA) - Erweitertes Niveau";
  const farbe = level === "BBR" ? "#1976d2" : "#2e7d32";
  const punkteProAufgabe = level === "BBR" ? 3 : 2;
  const dateStr = new Date().toLocaleDateString("de-DE");

  win.document.write(`
    <html>
    <head>
      <title>${level}-Pr√ºfung Mathematik</title>
      <script src="staticDiagrams.js"></script>
      <script src="diagramRenderer.js"></script>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; }
        h1 { text-align: center; margin-bottom: 5px; color: ${farbe}; }
        .kopf { margin-bottom: 30px; border-bottom: 3px solid ${farbe}; padding-bottom: 10px; }
        .infofeld { display: flex; justify-content: space-between; margin-top: 20px; }
        .linie { border-bottom: 1px solid black; width: 200px; display: inline-block; margin-left: 8px; }
        .aufgabe { margin-top: 30px; page-break-inside: avoid; border-left: 4px solid ${farbe}; padding-left: 15px; }
        .diagram-container { margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; text-align: center; }
        .diagram-container svg { max-width: 100%; height: auto; }
        .loesungsraum { height: ${level === "BBR" ? "80px" : "60px"}; border-bottom: 1px dashed #aaa; margin-top: 15px; margin-bottom: 15px; }
        .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
        .punkte { float: right; font-weight: bold; color: ${farbe}; }
        .hinweis { background: #fff3e0; padding: 8px; margin-top: 10px; font-size: 12px; border-left: 3px solid #ff9800; }
      </style>
    </head>
    <body>
      <div class="kopf">
        <h1>${titel}</h1>
        <div style="font-size: 18px; text-align: center; font-weight: bold;">
          ${level} - ${level === "BBR" ? "Berufsbildungsreife (Note 1‚Äì2)" : "Berufsorientierungsabschluss (Note 2‚Äì3)"}
        </div>
        
        <div class="infofeld">
          <div>Name: <span class="linie"></span></div>
          <div>Datum: <span class="linie"></span></div>
        </div>
        <div style="margin-top:10px;">
          Lerngruppe: <span class="linie"></span>
          <span style="float: right;">Punkte: ___ / ${exportedTasks.length * punkteProAufgabe}</span>
        </div>
        ${level === "BOA" ? '<div class="hinweis">Hinweis: Hilfsmittel wie Taschenrechner und Formelsammlung erlaubt.</div>' : ''}
      </div>

      ${formatiereAufgabenFuerPruefung(exportedTasks, level, punkteProAufgabe)}

      <div class="footer">
        Erstellt am ${dateStr} ‚Äì ${level}-Pr√ºfungssimulation (Note 1‚Äì2)
      </div>
      
      <script>
        // Diagramme nach dem Laden rendern
        window.onload = function() {
          if (typeof renderDiagram !== 'undefined') {
            document.querySelectorAll('.diagram-container[data-diagram]').forEach(function(container) {
              try {
                const diagramData = JSON.parse(container.dataset.diagram);
                renderDiagram(diagramData, container);
              } catch(e) {
                console.error('Fehler beim Rendern:', e);
              }
            });
          }
        };
      <\/script>
    </body>
    </html>
  `);

  win.document.close();
  win.focus();
}

function formatiereAufgabenFuerPruefung(tasks, level = "BBR", punkte = 3) {
  let nummer = 1;
  let html = "";

  tasks.forEach(task => {
    let diagramHtml = '';
    if (task.diagram) {
      diagramHtml = `<div class="diagram-container" data-diagram='${JSON.stringify(task.diagram).replace(/'/g, "&apos;")}'></div>`;
    }
    
    html += `
      <div class="aufgabe">
        <div style="display: flex; justify-content: space-between;">
          <strong>${nummer}. Aufgabe</strong>
          <span class="punkte">( ${punkte} Punkte )</span>
        </div>
        <div style="margin-top: 12px;">
          ${task.task}
        </div>
        ${diagramHtml}
        <div class="loesungsraum"></div>
        ${level === "BBR" ? '<div class="loesungsraum"></div>' : ''}
      </div>
    `;
    nummer++;
  });

  return html;
}

/* =========================================================
   INITIALISIERUNG
========================================================= */
document.addEventListener('DOMContentLoaded', function() {
  if (initTaskPool()) {
    switchMode();
    updateStatus();
    console.log('12.2.html erfolgreich initialisiert');
  } else {
    alert('Fehler beim Laden des Aufgabenpools!');
  }
});
</script>

</body>
</html>
