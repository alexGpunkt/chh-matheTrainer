<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mathe Trainer ‚Äì BOA / BBR (Note 2 bis 1)</title>

<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
  h1 { text-align:center; margin: 8px 0 14px; }

  #topbar { text-align:center; margin-bottom:10px; }
  button, select { padding:10px; font-size:16px; margin:4px; }

  #status { text-align:center; font-size:18px; font-weight:bold; margin-bottom:6px; }
  #progress { text-align:center; font-size:16px; margin-bottom:10px; }

  #card { max-width:820px; margin:auto; background:white; padding:25px; border-radius:10px; }
  #task { font-size:20px; margin-bottom:15px; }
  #answerArea { margin-top: 8px; }
  input { font-size:18px; padding:5px; width:220px; }
  #feedback { margin-top:10px; font-size:18px; font-weight:bold; }

  #solution { display:none; background:#eef6ff; padding:15px; border-radius:5px; margin-top:15px; }

  /* ===== PRINT / PDF EXPORT ===== */
  @media print {
    body { background:#fff; padding:0; }
    #topbar, #status, #progress, #card, h1 { display:none !important; }
    #printArea { display:block !important; }
  }

  #printArea { font-family: Arial, sans-serif; color:#000; padding:18mm; }
  .print-title { font-size:18pt; font-weight:bold; margin-bottom:6mm; }
  .print-meta { font-size:11pt; margin-bottom:8mm; }
  .print-line { border-bottom:1px solid #000; display:inline-block; width:70mm; height:6mm; vertical-align:bottom; margin-left:3mm; }
  .task-block { margin-bottom:8mm; padding-bottom:6mm; border-bottom:1px solid #ddd; }
  .task-head { font-weight:bold; margin-bottom:2mm; }
  .task-text { margin-bottom:4mm; }
  .work-space { height:22mm; border:1px solid #eee; background:#fafafa; }
  .page-break { page-break-before: always; break-before: page; }
</style>
<!-- Aufgabenpool als externe JS-Datei -->
<script src="pool_113.js"></script>
</head>

<body>

<h1>üéì Mathe-Trainer ‚Äì BOA / BBR (Note 2 bis 1)</h1>

<div id="topbar">
  <select id="mode" onchange="switchMode()">
    <option value="exam">Pr√ºfungsmodus (mit Eingabe)</option>
    <option value="cards">Karteikartenmodus</option>
  </select>

  <select id="level" onchange="onLevelChange()">
    <option value="boa">BOA (reduziert)</option>
    <option value="bbr">BBR (h√∂heres Niveau)</option>
  </select>

  <button onclick="startRound()">üé≤ Zufallsrunde starten</button>
  <button onclick="nextTaskRandom()">‚û°Ô∏è N√§chste Aufgabe (zuf√§llig)</button>
  <button onclick="nextTaskSameType()">üîÅ Gleicher Typ</button>
  <button onclick="toggleSolution()" id="solutionBtn">üìå L√∂sung anzeigen</button>
  <button onclick="exportWorksheetPDF()">üßæ PDF-√úbungsblatt</button>
  <button onclick="resetTrainer()">üîÑ Reset</button>
</div>

<div id="status">Punkte: 0</div>
<div id="progress">Noch keine Runde gestartet.</div>

<div id="card">
  <div id="task">Starte eine Zufallsrunde.</div>

  <div id="answerArea">
    Deine Antwort:
    <input type="text" id="userAnswer" />
    <button onclick="checkAnswer()">Antwort pr√ºfen</button>
  </div>

  <div id="feedback"></div>

  <div id="solution"></div>
</div>

<div id="printArea" style="display:none;"></div>

<script>
/* =========================================================
   STATE - NUR UI-LOGIK
   Aufgabenpool wird aus pool_113.js importiert
========================================================= */
let currentTask = null;        // Aktuelle Aufgabe mit allen Details
let currentAnswer = null;     // Richtige Antwort
let points = 0;

let roundActive = false;
let taskNumber = 0;
let totalTasks = 10;

let solvedCurrent = false;

// Merkt sich den zuletzt gezogenen Aufgabentyp (f√ºr "Gleicher Typ")
let lastCat = null;
let lastGenIndex = null;

// F√ºr Karteikarten: L√∂sung ist erst ‚Äûaufgedeckt‚Äú, wenn Nutzer klickt
let revealed = false;

/* =========================================================
   UTIL - NUR F√úR UI
========================================================= */
function getLevel() { return document.getElementById("level").value; }
function getMode() { return document.getElementById("mode").value; }

function fmt(n) {
  // ‚Äûsch√∂ne‚Äú Darstellung: Integer ohne Nachkommastellen, sonst max 2
  if (typeof n === "number") {
    if (Number.isInteger(n)) return String(n);
    return (Math.round(n * 100) / 100).toString().replace(".", ",");
  }
  return String(n);
}

function normalize(val) {
  return parseFloat(String(val).trim().replace(",", "."));
}

/* =========================================================
   MODE/UI
========================================================= */
function switchMode() {
  const mode = getMode();
  const answerArea = document.getElementById("answerArea");
  const status = document.getElementById("status");
  const btn = document.getElementById("solutionBtn");

  if (mode === "cards") {
    answerArea.style.display = "none";
    status.style.display = "none";
    btn.textContent = "üìå L√∂sung aufdecken";
  } else {
    answerArea.style.display = "block";
    status.style.display = "block";
    btn.textContent = "üìå L√∂sung anzeigen";
  }

  // aktuelle Karte/L√∂sung zur√ºcksetzen
  revealed = false;
  document.getElementById("solution").style.display = "none";
}

function onLevelChange() {
  // BOA/BBR wirkt sofort ‚Äì resetten nicht hart, aber verstecken L√∂sung und Feedback
  revealed = false;
  document.getElementById("solution").style.display = "none";
  document.getElementById("feedback").innerHTML = "";
}

/* =========================================================
   ROUND - UI-LOGIK
========================================================= */
function updateStatus() {
  document.getElementById("status").innerHTML = `Punkte: ${points}`;
}

function startRound() {
  console.log("=== Zufallsrunde wird gestartet ===");
  points = 0;
  taskNumber = 0;
  roundActive = true;
  solvedCurrent = false;
  lastCat = null;
  lastGenIndex = null;
  updateStatus();
  document.getElementById("progress").innerHTML = `Aufgabe 0 von ${totalTasks}`;
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("userAnswer").value = "";
  
  // ‚úÖ DIREKT die erste Aufgabe laden!
  nextTaskRandom();
}

function finishRound() {
  roundActive = false;
  document.getElementById("task").innerHTML = `üèÅ Runde beendet!`;
  document.getElementById("progress").innerHTML = `Endpunktzahl: ${points} Punkte`;
  document.getElementById("answerArea").style.display = getMode() === "exam" ? "block" : "none";
}

/* =========================================================
   TASK PICKING - NUTZT AUSGELAGERTE FUNKTIONEN
========================================================= */
function drawTask(cat, genIndex) {
  console.log(`Zeichne Aufgabe: Kategorie=${cat}, Generator=${genIndex}`);
  
  // ‚úÖ Nutzung der zentralen Trainer-Funktion aus pool_113.js
  const t = getTask113Trainer({ category: cat, generatorIndex: genIndex });

  if (!t) {
    console.error("Fehler: Keine Aufgabe erhalten!");
    return;
  }

  // Aktuelle Aufgabe speichern
  currentTask = t;
  currentAnswer = t.answer;
  
  lastCat = cat;
  lastGenIndex = genIndex;

  // UI reset
  solvedCurrent = false;
  revealed = false;

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  
  // ‚úÖ L√∂sung speichern f√ºr sp√§tere Anzeige
  document.getElementById("solution").innerHTML =
    "<b>L√∂sung Schritt-f√ºr-Schritt:</b><br><br>" + (t.solution || "‚Äî");

  // ‚úÖ Aufgabe anzeigen
  document.getElementById("task").innerHTML = `<b>${cat.toUpperCase()}</b><br>${t.task}`;
  
  console.log(`Aufgabe geladen: ${t.task.substring(0, 50)}...`);
}

/* N√§chste Aufgabe (Kategorie & Typ zuf√§llig) */
function nextTaskRandom() {
  console.log("nextTaskRandom aufgerufen");
  console.log(`roundActive=${roundActive}, taskNumber=${taskNumber}, totalTasks=${totalTasks}`);
  
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  
  taskNumber++;
  console.log(`Aufgabe ${taskNumber} von ${totalTasks}`);

  // ‚úÖ Zuf√§llige Kategorie mit Gewichtung
  const cat = getWeightedCategory();
  console.log(`Gewichtete Kategorie: ${cat}`);
  
  // ‚úÖ Pr√ºfen ob Kategorie existiert
  const poolSize = getTaskPoolSize(cat);
  console.log(`Pool-Gr√∂√üe f√ºr ${cat}: ${poolSize}`);
  
  if (poolSize === 0) {
    console.error(`Kategorie ${cat} hat keine Aufgaben!`);
    // Fallback auf "rechnen"
    const fallbackCat = "rechnen";
    const fallbackSize = getTaskPoolSize(fallbackCat);
    const genIndex = rand(0, fallbackSize - 1);
    drawTask(fallbackCat, genIndex);
  } else {
    const genIndex = rand(0, poolSize - 1);
    drawTask(cat, genIndex);
  }

  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks}`;
}

/* Weitere Aufgabe gleicher Typ (exakt gleiche Kategorie + gleicher Generator) */
function nextTaskSameType() {
  console.log("nextTaskSameType aufgerufen");
  
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  
  if (lastCat === null || lastGenIndex === null) {
    console.log("Kein letzter Typ vorhanden -> verwende zuf√§llige Aufgabe");
    nextTaskRandom();
    return;
  }

  taskNumber++;
  console.log(`Aufgabe ${taskNumber} von ${totalTasks} (gleicher Typ: ${lastCat}, Index ${lastGenIndex})`);

  drawTask(lastCat, lastGenIndex);

  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks} (gleicher Typ)`;
}

/* =========================================================
   CHECK ANSWER (nur im Pr√ºfungsmodus sinnvoll)
========================================================= */
function checkAnswer() {
  if (getMode() === "cards") {
    document.getElementById("feedback").innerHTML = "‚ÑπÔ∏è Karteikartenmodus: Keine Eingabepr√ºfung.";
    return;
  }
  if (solvedCurrent) {
    document.getElementById("feedback").innerHTML = "‚ö† Diese Aufgabe wurde bereits beantwortet.";
    return;
  }
  if (!currentAnswer) {
    document.getElementById("feedback").innerHTML = "‚ö† Keine aktive Aufgabe.";
    return;
  }

  const input = document.getElementById("userAnswer").value.trim();
  
  if (input === "") {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine Antwort eingeben.";
    return;
  }

  // Bei Sach-Aufgaben kann answer auch Text sein (z.B. Uhrzeit)
  if (typeof currentAnswer === "string") {
    const ok = input === currentAnswer;
    const feedback = document.getElementById("feedback");
    if (ok) {
      points += 3;
      feedback.innerHTML = "‚úî Richtig! +3 Punkte";
      feedback.style.color = "green";
    } else {
      feedback.innerHTML = `‚úò Falsch. Richtige L√∂sung: ${currentAnswer}`;
      feedback.style.color = "red";
    }
    solvedCurrent = true;
    updateStatus();
    return;
  }

  const userVal = normalize(input);
  if (isNaN(userVal)) {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine g√ºltige Zahl eingeben (z.B. 10,5).";
    return;
  }

  // Toleranz f√ºr Rundungsfehler
  if (Math.abs(userVal - currentAnswer) < 0.05) {
    points += 3;
    document.getElementById("feedback").innerHTML = "‚úî Richtig! +3 Punkte";
    document.getElementById("feedback").style.color = "green";
  } else {
    document.getElementById("feedback").innerHTML = `‚úò Falsch. Richtige L√∂sung: ${fmt(currentAnswer)}`;
    document.getElementById("feedback").style.color = "red";
  }

  solvedCurrent = true;
  updateStatus();
}

/* =========================================================
   SOLUTION TOGGLE
========================================================= */
function toggleSolution() {
  const sol = document.getElementById("solution");
  const mode = getMode();

  if (!currentTask) {
    alert("Keine aktive Aufgabe vorhanden.");
    return;
  }

  if (mode === "cards") {
    // Karteikarten: erst aufdecken, dann wieder verstecken
    revealed = !revealed;
    sol.style.display = revealed ? "block" : "none";
    return;
  }

  // Pr√ºfungsmodus: einfach anzeigen (kein Zwang zum Toggle, aber ok)
  sol.style.display = (sol.style.display === "block") ? "none" : "block";
}

/* =========================================================
   RESET
========================================================= */
function resetTrainer() {
  console.log("Trainer wird zur√ºckgesetzt");
  points = 0;
  taskNumber = 0;
  roundActive = false;
  solvedCurrent = false;
  lastCat = null;
  lastGenIndex = null;
  revealed = false;
  currentTask = null;
  currentAnswer = null;

  updateStatus();
  document.getElementById("task").innerHTML = "Starte eine Zufallsrunde.";
  document.getElementById("progress").innerHTML = "Noch keine Runde gestartet.";
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML = "";
}

/* =========================================================
   PDF EXPORT (Aufgaben + L√∂sungen)
========================================================= */
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function exportWorksheetPDF(tasksCount = 10, includeSolutions = true, avoidDuplicates = true) {
  const level = getLevel();
  const now = new Date();
  const dateStr = now.toLocaleDateString("de-DE");

  const picked = [];
  const seen = new Set();

  let safety = 0;
  while (picked.length < tasksCount && safety < tasksCount * 50) {
    safety++;

    // ‚úÖ Nutzung der zentralen Weighted-Category-Funktion
    const cat = getWeightedCategory();
    // ‚úÖ Nutzung der zentralen Pick-Funktion
    const t = pickTaskFromCategory(cat);
    if (!t) continue;

    const signature = (cat + "||" + t.task).replace(/\s+/g, " ").trim();
    if (avoidDuplicates && seen.has(signature)) continue;

    seen.add(signature);
    picked.push({ cat, t });
  }

  if (picked.length === 0) {
    alert("Keine Aufgaben gefunden ‚Äì pr√ºfe TASKPOOL.");
    return;
  }

  const title = `Mathe-√úbungsblatt (${level.toUpperCase()}) - Note 2-1`;
  let html = `
    <div class="print-title">${escapeHtml(title)}</div>
    <div class="print-meta">
      Datum: <span class="print-line"></span> &nbsp;&nbsp;
      Name: <span class="print-line"></span> &nbsp;&nbsp;
      Klasse: <span class="print-line" style="width:30mm;"></span>
      <div style="margin-top:3mm; color:#444;">Erstellt am ${escapeHtml(dateStr)} ‚Äì ${picked.length} Aufgaben (h√∂heres Niveau)</div>
    </div>
  `;

  picked.forEach((item, i) => {
    const t = item.t;
    html += `
      <div class="task-block">
        <div class="task-head">Aufgabe ${i + 1} (${escapeHtml(item.cat)})</div>
        <div class="task-text">${t.task}</div>
        <div class="work-space"></div>
      </div>
    `;
  });

  if (includeSolutions) {
    html += `<div class="page-break"></div>`;
    html += `
      <div class="print-title">L√∂sungen ‚Äì ${escapeHtml(title)}</div>
      <div class="print-meta">Hinweis: Detaillierter Rechenweg f√ºr h√∂heres Niveau.</div>
    `;

    picked.forEach((item, i) => {
      const t = item.t;
      html += `
        <div class="task-block">
          <div class="task-head">L√∂sung zu Aufgabe ${i + 1} (${escapeHtml(item.cat)})</div>
          <div class="task-text"><b>Antwort:</b> ${escapeHtml(fmt(t.answer))}</div>
          <div>${t.solution || "‚Äî"}</div>
        </div>
      `;
    });
  }

  document.getElementById("printArea").innerHTML = html;
  window.print();
}

/* =========================================================
   HILFSFUNKTION: Zufallszahl (Fallback falls nicht aus pool_113.js)
========================================================= */
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", function() {
  console.log("12.2.html geladen, initialisiere...");
  switchMode();
  updateStatus();
  
  // Pr√ºfe ob pool_113.js korrekt geladen wurde
  if (typeof getWeightedCategory === 'undefined') {
    console.error("pool_113.js nicht geladen! Funktionen fehlen.");
    alert("Fehler: Aufgabenpool konnte nicht geladen werden!");
  } else {
    console.log("pool_113.js erfolgreich geladen");
    console.log("Verf√ºgbare Kategorien:", getAvailableCategories ? getAvailableCategories() : "nicht verf√ºgbar");
  }
});
</script>

</body>
</html>
