<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mathe Trainer ‚Äì BOA / BBR (Note 2 bis 1)</title>

<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
  h1 { text-align:center; margin: 8px 0 14px; }

  #topbar { text-align:center; margin-bottom:10px; }
  button, select { padding:10px; font-size:16px; margin:4px; }

  #status { text-align:center; font-size:18px; font-weight:bold; margin-bottom:6px; }
  #progress { text-align:center; font-size:16px; margin-bottom:10px; }

  #card { max-width:820px; margin:auto; background:white; padding:25px; border-radius:10px; }
  #task { font-size:20px; margin-bottom:15px; }
  #answerArea { margin-top: 8px; }
  input { font-size:18px; padding:5px; width:220px; }
  #feedback { margin-top:10px; font-size:18px; font-weight:bold; }

  #solution { display:none; background:#eef6ff; padding:15px; border-radius:5px; margin-top:15px; }

  /* Aufgaben-Container f√ºr Export */
  #aufgabenContainer {
    margin-top: 30px;
    border-top: 2px solid #1976d2;
    padding-top: 20px;
  }
  .aufgabe {
    background: #f9f9f9;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #1976d2;
    border-radius: 4px;
  }
  .loesung {
    display: none;
  }
  
  /* ===== PRINT / PDF EXPORT ===== */
  @media print {
    body { background:#fff; padding:0; }
    #topbar, #status, #progress, #card, h1 { display:none !important; }
    #printArea { display:block !important; }
  }

  #printArea { font-family: Arial, sans-serif; color:#000; padding:18mm; display:none; }
  .print-title { font-size:18pt; font-weight:bold; margin-bottom:6mm; }
  .print-meta { font-size:11pt; margin-bottom:8mm; }
  .print-line { border-bottom:1px solid #000; display:inline-block; width:70mm; height:6mm; vertical-align:bottom; margin-left:3mm; }
  .task-block { margin-bottom:8mm; padding-bottom:6mm; border-bottom:1px solid #ddd; }
  .task-head { font-weight:bold; margin-bottom:2mm; }
  .task-text { margin-bottom:4mm; }
  .work-space { height:22mm; border:1px solid #eee; background:#fafafa; }
  .page-break { page-break-before: always; break-before: page; }
</style>
</head>

<body>

<h1>üéì Mathe-Trainer ‚Äì BOA / BBR (Note 2 bis 1)</h1>

<div id="topbar">
  <select id="mode" onchange="switchMode()">
    <option value="exam">Pr√ºfungsmodus (mit Eingabe)</option>
    <option value="cards">Karteikartenmodus</option>
  </select>

  <select id="level" onchange="onLevelChange()">
    <option value="boa">BOA (reduziert)</option>
    <option value="bbr">BBR (h√∂heres Niveau)</option>
  </select>

  <button onclick="startRound()">üé≤ Zufallsrunde starten</button>
  <button onclick="nextTaskRandom()">‚û°Ô∏è N√§chste Aufgabe (zuf√§llig)</button>
  <button onclick="nextTaskSameType()">üîÅ Gleicher Typ</button>
  <button onclick="toggleSolution()" id="solutionBtn">üìå L√∂sung anzeigen</button>
  <button onclick="exportiereBBRPruefung()">üßæ BBR-Pr√ºfung exportieren</button>
  <button onclick="exportiereBOAPruefung()">üìò BOA-Pr√ºfung exportieren</button>
  <button onclick="resetTrainer()">üîÑ Reset</button>
</div>

<div id="status">Punkte: 0</div>
<div id="progress">Noch keine Runde gestartet.</div>

<div id="card">
  <div id="task">Starte eine Zufallsrunde.</div>

  <div id="answerArea">
    Deine Antwort:
    <input type="text" id="userAnswer" />
    <button onclick="checkAnswer()">Antwort pr√ºfen</button>
  </div>

  <div id="feedback"></div>

  <div id="solution"></div>
  
  <!-- Aufgaben-Container f√ºr Export -->
  <div id="aufgabenContainer"></div>
</div>

<div id="printArea" style="display:none;"></div>

<script>
/* =========================================================
   STATE
========================================================= */
let currentAnswer = null;
let points = 0;

let roundActive = false;
let taskNumber = 0;
let totalTasks = 10;

let solvedCurrent = false;

let lastCat = null;
let lastGenIndex = null;

let revealed = false;

// Gespeicherte Aufgaben f√ºr Export
let exportedTasks = [];

/* =========================================================
   UTIL
========================================================= */
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function getLevel() { return document.getElementById("level").value; }
function getMode() { return document.getElementById("mode").value; }

function fmt(n) {
  if (typeof n === "number") {
    if (Number.isInteger(n)) return String(n);
    return (Math.round(n * 100) / 100).toString().replace(".", ",");
  }
  return String(n);
}

function steps(lines, result) {
  let html = "";
  lines.forEach((line, i) => html += `Schritt ${i + 1}: ${line}<br>`);
  html += `<br><b>Ergebnis: ${fmt(result)}</b>`;
  return html;
}

function genTask(taskHtml, answer, stepLines) {
  return { task: taskHtml, answer, solution: steps(stepLines, answer) };
}

function round2(x) {
  return Math.round(x * 100) / 100;
}

/* =========================================================
   PR√úFUNGS-REALISTISCHE GEWICHTUNG
========================================================= */
const weightedCategories = [
  "rechnen","rechnen","rechnen","rechnen","rechnen",
  "sach","sach","sach","sach","sach",
  "prozent","prozent","prozent","prozent",
  "geometrie","geometrie","geometrie","geometrie"
];

/* =========================================================
   TASKPOOL (h√∂heres Niveau f√ºr Note 2-1)
========================================================= */
const TASKPOOL = {
  rechnen: [
    () => {
      const x = rand(-3, 8);
      const ans = 2 * (3 * x - 4) - (x - 5);
      return genTask(
        `Berechne den Wert des Terms f√ºr x = ${x}:<br>
         <b>2¬∑(3x ‚àí 4) ‚àí (x ‚àí 5)</b>`,
        ans,
        [
          `Klammern aufl√∂sen: 2¬∑3x ‚àí 2¬∑4 = 6x ‚àí 8`,
          `Minusklammer: ‚àí (x ‚àí 5) = ‚àíx + 5`,
          `Zusammenfassen: 6x ‚àí 8 ‚àí x + 5 = 5x ‚àí 3`,
          `Einsetzen von x = ${x}: 5¬∑${x} ‚àí 3 = ${5*x} ‚àí 3`
        ]
      );
    },
    () => {
      const x = rand(-5, 10);
      const result = 3 * (x - 2) + 4;
      return genTask(
        `L√∂se nach x:<br>
         <b>3(x ‚àí 2) + 4 = ${result}</b>`,
        x,
        [
          `Klammern aufl√∂sen: 3x ‚àí 6 + 4 = 3x ‚àí 2`,
          `Gleichung: 3x ‚àí 2 = ${result}`,
          `+2 auf beiden Seiten: 3x = ${result + 2}`,
          `√∑3: x = ${x}`
        ]
      );
    },
    () => {
      const a = rand(2, 6);
      const b = rand(1, 8);
      const c = rand(3, 9);
      const x = rand(-4, 9);
      const ans = a * (b * x + c) - (x - a);
      return genTask(
        `Berechne f√ºr x = ${x}:<br>
         <b>${a}¬∑(${b}x + ${c}) ‚àí (x ‚àí ${a})</b>`,
        ans,
        [
          `Erste Klammer: ${a}¬∑${b}x + ${a}¬∑${c} = ${a*b}x + ${a*c}`,
          `Zweite Klammer: ‚àíx + ${a}`,
          `Zusammenfassen: ${a*b}x + ${a*c} ‚àí x + ${a} = ${a*b-1}x + ${a*c+a}`,
          `Einsetzen: ${a*b-1}¬∑${x} + ${a*c+a}`
        ]
      );
    },
    ...Array.from({ length: 18 }, () => () => {
      const x = rand(-4, 9);
      const a = rand(2, 6);
      const b = rand(1, 8);
      const c = rand(3, 9);
      const ans = a * (b * x + c) - (x - a);
      return genTask(
        `Berechne f√ºr x = ${x}:<br>
         <b>${a}¬∑(${b}x + ${c}) ‚àí (x ‚àí ${a})</b>`,
        ans,
        [
          `Klammern aufl√∂sen`,
          `Zusammenfassen`,
          `Einsetzen von x = ${x}`
        ]
      );
    })
  ],
  prozent: [
    () => {
      const g = rand(150, 600);
      const p = rand(10, 35);
      const ans = Number((g * (1 + p / 100)).toFixed(2));
      return genTask(
        `Ein Produkt kostet ${g} ‚Ç¨.<br>
         Der Preis wird um ${p}% erh√∂ht.<br>
         <b>Bestimme den neuen Preis.</b>`,
        ans,
        [
          `100% + ${p}% = ${100 + p}%`,
          `Neuer Preis = Grundwert √ó (100 + p)/100`,
          `${g} √ó ${100 + p} / 100`,
          `Ausrechnen: ${g} √ó ${(100+p)/100}`
        ]
      );
    },
    () => {
      const g = rand(120, 400);
      const p = rand(10, 40);
      const w = Number((g * p / 100).toFixed(2));
      return genTask(
        `${w} ‚Ç¨ entsprechen ${p}%.<br>
         <b>Bestimme den Grundwert.</b>`,
        g,
        [
          `Formel: G = W √ó 100 / p`,
          `Einsetzen: ${w} √ó 100 / ${p}`,
          `Ausrechnen: ${w} √ó ${100/p}`
        ]
      );
    },
    () => {
      const g = rand(200, 800);
      const p1 = rand(15, 30);
      const p2 = rand(5, 20);
      const ans = Number((g * (1 - p1/100) * (1 + p2/100)).toFixed(2));
      return genTask(
        `Ein Preis von ${g} ‚Ç¨ wird um ${p1}% reduziert, dann um ${p2}% erh√∂ht.<br>
         <b>Neuer Preis?</b>`,
        ans,
        [
          `Erster Schritt: ${g} √ó ${100-p1}/100 = ${(g * (1 - p1/100)).toFixed(2)}`,
          `Zweiter Schritt: √ó ${100+p2}/100`,
          `Ausrechnen: ${(g * (1 - p1/100)).toFixed(2)} √ó ${(100+p2)/100}`
        ]
      );
    },
    () => {
      const g = rand(250, 700);
      const p1 = rand(10, 25);
      const p2 = rand(5, 15);
      const ans = Number((g * (1 - p1/100) * (1 + p2/100)).toFixed(2));
      return genTask(
        `Preis: ${g} ‚Ç¨, erst ${p1}% Rabatt, dann ${p2}% Steuer.<br>
         <b>Endpreis?</b>`,
        ans,
        [
          `Nach Rabatt: ${100-p1}% von ${g} ‚Ç¨`,
          `Nach Steuer: ${100+p2}% vom rabattierten Preis`,
          `${g} √ó ${(100-p1)/100} √ó ${(100+p2)/100}`
        ]
      );
    }
  ],
  geometrie: [
    () => {
      const a = rand(4, 10);
      const b = rand(5, 12);
      const h = rand(6, 18);
      const ans = a * b * h;
      return genTask(
        `Ein Prisma hat eine rechteckige Grundfl√§che
         mit a = ${a} cm und b = ${b} cm.<br>
         H√∂he h = ${h} cm.<br>
         <b>Berechne das Volumen.</b>`,
        ans,
        [
          `Grundfl√§che: G = a √ó b = ${a} √ó ${b} = ${a*b} cm¬≤`,
          `Volumen: V = G √ó h = ${a*b} √ó ${h}`,
          `Ausrechnen: ${a*b} √ó ${h}`
        ]
      );
    },
    () => {
      const a = rand(4, 10), b = rand(5, 12), h = rand(6, 14);
      const ans = Number(Math.sqrt(a*a + b*b + h*h).toFixed(2));
      return genTask(
        `Ein Quader besitzt die Kantenl√§ngen
         a=${a} cm, b=${b} cm, h=${h} cm.<br>
         <b>Bestimme die Raumdiagonale.</b>`,
        ans,
        [
          `Pythagoras im Raum: d¬≤ = a¬≤ + b¬≤ + h¬≤`,
          `d¬≤ = ${a}¬≤ + ${b}¬≤ + ${h}¬≤ = ${a*a} + ${b*b} + ${h*h} = ${a*a + b*b + h*h}`,
          `Wurzel ziehen: d = ‚àö${a*a + b*b + h*h}`
        ]
      );
    },
    () => {
      const r = rand(3, 8);
      const h = rand(8, 20);
      const ans = Number((Math.PI * r * r * h).toFixed(2));
      return genTask(
        `Ein Zylinder hat Radius r = ${r} cm und H√∂he h = ${h} cm.<br>
         (œÄ ‚âà 3,14)<br>
         <b>Berechne das Volumen.</b>`,
        ans,
        [
          `Formel: V = œÄ √ó r¬≤ √ó h`,
          `Einsetzen: 3,14 √ó ${r}¬≤ √ó ${h}`,
          `${r}¬≤ = ${r*r}`,
          `3,14 √ó ${r*r} √ó ${h}`
        ]
      );
    },
    () => {
      const a = rand(4, 10);
      const h = rand(6, 16);
      const ans = 2 * a * a + 4 * a * h;
      return genTask(
        `Ein Prisma hat eine quadratische Grundfl√§che mit a = ${a} cm.<br>
         H√∂he h = ${h} cm.<br>
         <b>Berechne die Oberfl√§che.</b>`,
        ans,
        [
          `Grundfl√§che: G = a¬≤ = ${a}¬≤ = ${a*a} cm¬≤`,
          `Mantelfl√§che: M = 4 √ó a √ó h = 4 √ó ${a} √ó ${h} = ${4*a*h} cm¬≤`,
          `Oberfl√§che: O = 2√óG + M = 2√ó${a*a} + ${4*a*h}`,
          `2√ó${a*a} = ${2*a*a}, plus ${4*a*h}`
        ]
      );
    },
    ...Array.from({ length: 10 }, () => () => {
      const typ = rand(1, 3);
      if (typ === 1) {
        const r = rand(3, 7);
        const h = rand(6, 15);
        const ans = Number((1/3 * Math.PI * r * r * h).toFixed(2));
        return genTask(
          `Ein Kegel hat Radius r = ${r} cm und H√∂he h = ${h} cm.<br>
           (œÄ ‚âà 3,14) Berechne das Volumen.`,
          ans,
          [
            `Formel: V = 1/3 √ó œÄ √ó r¬≤ √ó h`,
            `1/3 √ó 3,14 √ó ${r}¬≤ √ó ${h}`,
            `Ausrechnen`
          ]
        );
      } else if (typ === 2) {
        const r = rand(2, 8);
        const ans = Number((4 * Math.PI * r * r).toFixed(2));
        return genTask(
          `Eine Kugel hat Radius r = ${r} cm.<br>
           (œÄ ‚âà 3,14) Berechne die Oberfl√§che.`,
          ans,
          [
            `Formel: O = 4 √ó œÄ √ó r¬≤`,
            `4 √ó 3,14 √ó ${r}¬≤`,
            `Ausrechnen`
          ]
        );
      } else {
        const a = rand(4, 10);
        const h = rand(6, 16);
        const ans = Number((1/3 * a * a * h).toFixed(2));
        return genTask(
          `Eine quadratische Pyramide hat Grundkante a = ${a} cm und H√∂he h = ${h} cm.<br>
           Berechne das Volumen.`,
          ans,
          [
            `Formel: V = 1/3 √ó G √ó h`,
            `Grundfl√§che: a¬≤ = ${a}¬≤ = ${a*a}`,
            `1/3 √ó ${a*a} √ó ${h}`
          ]
        );
      }
    })
  ],
  sach: [
    () => {
      const km = rand(80, 420);
      const h  = rand(2, 7);
      const ans = Number((km / h).toFixed(1));
      return genTask(
        `Ein Auto f√§hrt ${km} km in ${h} h.<br>
         <b>Berechne die Durchschnittsgeschwindigkeit.</b>`,
        ans,
        [
          `Formel: v = s : t`,
          `v = ${km} km : ${h} h`,
          `Ausrechnen: ${km} √∑ ${h}`
        ]
      );
    },
    () => {
      const r = rand(3, 8);
      const h = rand(8, 18);
      const u = Number((2 * Math.PI * r).toFixed(2));
      const ans = Number(Math.sqrt(u*u + h*h).toFixed(2));
      return genTask(
        `Der Mantel eines Zylinders wird als Rechteck dargestellt.<br>
         Umfang der Grundfl√§che: ${u} cm<br>
         H√∂he: ${h} cm<br>
         <b>Berechne die L√§nge der Diagonale.</b>`,
        ans,
        [
          `Diagonale im Rechteck: d¬≤ = u¬≤ + h¬≤`,
          `d¬≤ = ${u}¬≤ + ${h}¬≤ = ${u*u} + ${h*h} = ${u*u + h*h}`,
          `Wurzel ziehen: d = ‚àö${u*u + h*h}`
        ]
      );
    },
    () => {
      const startH = rand(8, 14);
      const durMin = rand(85, 240);
      const total = startH*60 + durMin;
      const hh = Math.floor(total/60) % 24;
      const mm = String(total%60).padStart(2,"0");
      const ans = `${hh}:${mm}`;
      return {
        task: `Ein Zug startet um <b>${startH}:00</b> Uhr und f√§hrt <b>${durMin}</b> Minuten.<br>
               <b>Ankunftszeit?</b>`,
        answer: ans,
        solution: steps(
          [
            `Startzeit in Minuten: ${startH}¬∑60 = ${startH*60}`,
            `+ Fahrzeit: ${startH*60} + ${durMin} = ${total} Minuten`,
            `Zur√ºck in Stunden und Minuten: ${total} √∑ 60 = ${Math.floor(total/60)} h ${total%60} min`,
            `Uhrzeit: ${hh}:${mm}`
          ],
          ans
        )
      };
    },
    () => {
      const c1 = rand(10, 30);
      const m1 = rand(100, 300);
      const c2 = rand(40, 60);
      const m2 = rand(50, 150);
      const gesamt = m1 + m2;
      const konz = round2((c1*m1 + c2*m2) / gesamt);
      return genTask(
        `${m1}g einer ${c1}%igen L√∂sung werden mit ${m2}g einer ${c2}%igen L√∂sung gemischt.<br>
         Konzentration der Mischung?`,
        konz,
        [
          `Reine Substanz 1: ${c1}% von ${m1}g = ${c1*m1/100}g`,
          `Reine Substanz 2: ${c2}% von ${m2}g = ${c2*m2/100}g`,
          `Gesamtmenge reine Substanz: ${c1*m1/100} + ${c2*m2/100} = ${(c1*m1 + c2*m2)/100}g`,
          `Gesamtmenge Mischung: ${m1} + ${m2} = ${gesamt}g`,
          `Konzentration: (${(c1*m1 + c2*m2)/100} √∑ ${gesamt}) √ó 100`
        ]
      );
    },
    ...Array.from({ length: 8 }, () => () => {
      const typ = rand(1, 3);
      if (typ === 1) {
        const real = rand(20, 100);
        const scale = rand(10, 50);
        const map = real/scale;
        return genTask(
          `Im Ma√üstab 1:${scale} entspricht ${map.toFixed(1)} cm auf der Karte wie vielen Metern in Wirklichkeit?`,
          real,
          [
            `1 cm auf Karte = ${scale} cm in Wirklichkeit`,
            `${map.toFixed(1)} cm √ó ${scale} = ${(map*scale).toFixed(1)} cm`,
            `In Metern: ${(map*scale/100).toFixed(1)} m`
          ]
        );
      } else if (typ === 2) {
        const kapital = rand(500, 2000);
        const zins = rand(2, 5);
        const jahre = rand(2, 5);
        const ans = Number((kapital * Math.pow(1 + zins/100, jahre)).toFixed(2));
        return genTask(
          `${kapital} ‚Ç¨ werden zu ${zins}% Zinseszins angelegt.<br>
           Wie viel nach ${jahre} Jahren?`,
          ans,
          [
            `Formel: K_end = K √ó (1 + p/100)^n`,
            `${kapital} √ó (1 + ${zins}/100)^${jahre}`,
            `${kapital} √ó ${(1 + zins/100).toFixed(3)}^${jahre}`
          ]
        );
      } else {
        const a = rand(2, 8);
        const b = rand(3, 12);
        const total = rand(50, 200);
        const anteilA = total * a/(a+b);
        return genTask(
          `Im Verh√§ltnis ${a}:${b} werden ${total} ‚Ç¨ aufgeteilt.<br>
           Wie viel erh√§lt der erste?`,
          Number(anteilA.toFixed(2)),
          [
            `Gesamte Teile: ${a} + ${b} = ${a+b}`,
            `Ein Teil: ${total} √∑ ${a+b} = ${(total/(a+b)).toFixed(2)}`,
            `Erster: ${a} Teile = ${a} √ó ${(total/(a+b)).toFixed(2)}`
          ]
        );
      }
    })
  ]
};

/* =========================================================
   MODE/UI
========================================================= */
function switchMode() {
  const mode = getMode();
  const answerArea = document.getElementById("answerArea");
  const status = document.getElementById("status");
  const btn = document.getElementById("solutionBtn");

  if (mode === "cards") {
    answerArea.style.display = "none";
    status.style.display = "none";
    btn.textContent = "üìå L√∂sung aufdecken";
  } else {
    answerArea.style.display = "block";
    status.style.display = "block";
    btn.textContent = "üìå L√∂sung anzeigen";
  }

  revealed = false;
  document.getElementById("solution").style.display = "none";
}

function onLevelChange() {
  revealed = false;
  document.getElementById("solution").style.display = "none";
  document.getElementById("feedback").innerHTML = "";
}

/* =========================================================
   ROUND
========================================================= */
function updateStatus() {
  document.getElementById("status").innerHTML = `Punkte: ${points}`;
}

function startRound() {
  points = 0;
  taskNumber = 0;
  roundActive = true;
  solvedCurrent = false;
  exportedTasks = [];
  updateStatus();
  nextTaskRandom();
}

function finishRound() {
  roundActive = false;
  document.getElementById("task").innerHTML = `üèÅ Runde beendet!`;
  document.getElementById("progress").innerHTML = `Endpunktzahl: ${points} Punkte`;
}

/* =========================================================
   TASK PICKING
========================================================= */
function pickCategoryWeighted() {
  return weightedCategories[rand(0, weightedCategories.length - 1)];
}

function drawTask(cat, genIndex) {
  const list = TASKPOOL[cat];
  const gen = list[genIndex];
  const t = gen();

  lastCat = cat;
  lastGenIndex = genIndex;

  currentAnswer = t.answer;

  solvedCurrent = false;
  revealed = false;

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML =
    "<b>L√∂sung Schritt-f√ºr-Schritt:</b><br><br>" + (t.solution || "‚Äî");

  document.getElementById("task").innerHTML = `(${cat}) ${t.task}`;
  
  // Aufgabe f√ºr Export speichern
  exportedTasks.push({
    cat: cat,
    task: t.task,
    answer: t.answer,
    solution: t.solution
  });
  
  // Aufgaben im Container rendern
  renderTasksInContainer();
}

function renderTasksInContainer() {
  const container = document.getElementById("aufgabenContainer");
  container.innerHTML = "";
  
  exportedTasks.forEach((task, index) => {
    const aufgabeDiv = document.createElement("div");
    aufgabeDiv.className = "aufgabe";
    aufgabeDiv.id = `export_aufgabe_${index}`;
    
    const aufgabeHtml = `
      <strong>Aufgabe ${index + 1} (${task.cat}):</strong>
      <div style="margin-top: 8px;">${task.task}</div>
      <div class="loesung" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 3px solid #2e7d32;">
        <strong>L√∂sung:</strong> ${task.answer}<br><br>
        <strong>Rechenweg:</strong><br>${task.solution || "‚Äî"}
      </div>
    `;
    
    aufgabeDiv.innerHTML = aufgabeHtml;
    container.appendChild(aufgabeDiv);
  });
}

function nextTaskRandom() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  taskNumber++;

  const cat = pickCategoryWeighted();
  const genIndex = rand(0, TASKPOOL[cat].length - 1);

  drawTask(cat, genIndex);

  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks}`;
}

function nextTaskSameType() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  if (lastCat === null || lastGenIndex === null) {
    nextTaskRandom();
    return;
  }

  drawTask(lastCat, lastGenIndex);
  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks} (gleicher Typ)`;
}

/* =========================================================
   CHECK ANSWER
========================================================= */
function normalize(val) {
  return parseFloat(String(val).trim().replace(",", "."));
}

function checkAnswer() {
  if (getMode() === "cards") {
    document.getElementById("feedback").innerHTML = "‚ÑπÔ∏è Karteikartenmodus: Keine Eingabepr√ºfung.";
    return;
  }
  if (solvedCurrent) return;

  const input = document.getElementById("userAnswer").value.trim();

  if (typeof currentAnswer === "string") {
    const ok = input === currentAnswer;
    document.getElementById("feedback").innerHTML = ok
      ? "‚úî Richtig! +3 Punkte"
      : `‚úò Falsch. Richtige L√∂sung: ${currentAnswer}`;
    if (ok) points += 3;
    solvedCurrent = true;
    updateStatus();
    return;
  }

  const userVal = normalize(input);
  if (isNaN(userVal)) {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine Zahl eingeben.";
    return;
  }

  if (Math.abs(userVal - currentAnswer) < 0.05) {
    points += 3;
    document.getElementById("feedback").innerHTML = "‚úî Richtig! +3 Punkte";
  } else {
    document.getElementById("feedback").innerHTML = `‚úò Falsch. Richtige L√∂sung: ${fmt(currentAnswer)}`;
  }

  solvedCurrent = true;
  updateStatus();
}

/* =========================================================
   SOLUTION TOGGLE
========================================================= */
function toggleSolution() {
  const sol = document.getElementById("solution");
  const mode = getMode();

  if (mode === "cards") {
    revealed = !revealed;
    sol.style.display = revealed ? "block" : "none";
    return;
  }

  sol.style.display = (sol.style.display === "block") ? "none" : "block";
}

/* =========================================================
   RESET
========================================================= */
function resetTrainer() {
  points = 0;
  taskNumber = 0;
  roundActive = false;
  solvedCurrent = false;
  lastCat = null;
  lastGenIndex = null;
  revealed = false;
  exportedTasks = [];

  updateStatus();
  document.getElementById("task").innerHTML = "Starte eine Zufallsrunde.";
  document.getElementById("progress").innerHTML = "Noch keine Runde gestartet.";
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML = "";
  document.getElementById("aufgabenContainer").innerHTML = "";
}

/* =========================================================
   EXPORT-FUNKTIONEN (BBR/BOA Pr√ºfungslayout)
========================================================= */
function exportiereBBRPruefung() {
  exportierePruefungMitLevel("BBR");
}

function exportiereBOAPruefung() {
  exportierePruefungMitLevel("BOA");
}

function exportierePruefungMitLevel(level) {
  const container = document.getElementById("aufgabenContainer");

  if (!container || container.innerHTML.trim() === "" || exportedTasks.length === 0) {
    alert("Keine Aufgaben vorhanden. Bitte zuerst eine Zufallsrunde starten.");
    return;
  }

  const clone = container.cloneNode(true);

  // L√∂sungen entfernen
  clone.querySelectorAll(".loesung").forEach(el => el.remove());

  // Buttons entfernen
  clone.querySelectorAll("button").forEach(btn => btn.remove());

  const win = window.open("", "_blank");
  const titel = level === "BBR" 
    ? "Vergleichende Arbeit ‚Äì Mathematik (BBR)" 
    : "Vergleichende Arbeit ‚Äì Mathematik (BOA)";
  const farbe = level === "BBR" ? "#1976d2" : "#2e7d32";
  const punkteProAufgabe = level === "BBR" ? 3 : 2;

  win.document.write(`
    <html>
    <head>
      <title>${level}-Pr√ºfung Mathematik</title>
      <style>
        @media print {
          body { margin: 0; }
        }
        body {
          font-family: Arial, sans-serif;
          padding: 40px;
          line-height: 1.6;
        }
        h1 {
          text-align: center;
          margin-bottom: 5px;
          color: ${farbe};
        }
        .kopf {
          margin-bottom: 30px;
          border-bottom: 3px solid ${farbe};
          padding-bottom: 10px;
        }
        .infofeld {
          display: flex;
          justify-content: space-between;
          margin-top: 20px;
          flex-wrap: wrap;
        }
        .linie {
          border-bottom: 1px solid black;
          width: 200px;
          display: inline-block;
          margin-left: 8px;
        }
        .aufgabe {
          margin-top: 30px;
          page-break-inside: avoid;
          border-left: 4px solid ${farbe};
          padding-left: 15px;
        }
        .loesungsraum {
          height: ${level === "BBR" ? "80px" : "60px"};
          border-bottom: 1px dashed #aaa;
          margin-top: 15px;
          margin-bottom: 15px;
        }
        .footer {
          margin-top: 50px;
          text-align: center;
          font-size: 12px;
          color: #666;
        }
        .punkte {
          float: right;
          font-weight: bold;
          color: ${farbe};
        }
        .hinweis {
          background: #fff3e0;
          padding: 8px;
          margin-top: 10px;
          font-size: 12px;
          border-left: 3px solid #ff9800;
        }
      </style>
    </head>
    <body>
      <div class="kopf">
        <h1>${titel}</h1>
        <div style="font-size: 18px; text-align: center; font-weight: bold;">
          ${level} - ${level === "BBR" ? "Berufsbildungsreife (Note 1‚Äì2)" : "Berufsorientierungsabschluss (Note 2‚Äì3)"}
        </div>
        
        <div class="infofeld">
          <div>Name: <span class="linie"></span></div>
          <div>Datum: <span class="linie"></span></div>
        </div>
        <div style="margin-top:10px;">
          Lerngruppe: <span class="linie"></span>
          <span style="float: right;">Punkte: ___ / ${exportedTasks.length * punkteProAufgabe}</span>
        </div>
        ${level === "BOA" ? '<div class="hinweis">Hinweis: Hilfsmittel wie Taschenrechner und Formelsammlung erlaubt.</div>' : ''}
      </div>

      ${formatiereAufgabenFuerPruefung(clone, level, punkteProAufgabe)}

      <div class="footer">
        Erstellt am ${new Date().toLocaleDateString('de-DE')} ‚Äì ${level}-Pr√ºfungssimulation
      </div>
    </body>
    </html>
  `);

  win.document.close();
  win.focus();
}

function formatiereAufgabenFuerPruefung(clone, level = "BBR", punkte = 3) {
  let nummer = 1;
  let html = "";

  clone.querySelectorAll(".aufgabe").forEach(aufgabe => {
    const aufgabeText = aufgabe.innerHTML.replace(/<strong>Aufgabe \d+ \(.*?\):<\/strong>/, '').trim();
    
    html += `
      <div class="aufgabe">
        <div style="display: flex; justify-content: space-between;">
          <strong>${nummer}. Aufgabe</strong>
          <span class="punkte">( ${punkte} Punkte )</span>
        </div>
        <div style="margin-top: 12px;">
          ${aufgabeText}
        </div>
        <div class="loesungsraum"></div>
        ${level === "BBR" ? '<div class="loesungsraum"></div>' : ''}
      </div>
    `;
    nummer++;
  });

  return html;
}

/* INIT */
switchMode();
updateStatus();
</script>

</body>
</html>

