<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mathe Trainer ‚Äì BOA / BBR (Vollversion)</title>

<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
  h1 { text-align:center; margin: 8px 0 14px; }

  #topbar { text-align:center; margin-bottom:10px; }
  button, select { padding:10px; font-size:16px; margin:4px; }

  #status { text-align:center; font-size:18px; font-weight:bold; margin-bottom:6px; }
  #progress { text-align:center; font-size:16px; margin-bottom:10px; }

  #card { max-width:820px; margin:auto; background:white; padding:25px; border-radius:10px; }
  #task { font-size:20px; margin-bottom:15px; }
  #answerArea { margin-top: 8px; }
  input { font-size:18px; padding:5px; width:220px; }
  #feedback { margin-top:10px; font-size:18px; font-weight:bold; }

  #solution { display:none; background:#eef6ff; padding:15px; border-radius:5px; margin-top:15px; }

  /* ===== PRINT / PDF EXPORT ===== */
  @media print {
    body { background:#fff; padding:0; }
    #topbar, #status, #progress, #card, h1 { display:none !important; }
    #printArea { display:block !important; }
  }

  #printArea { font-family: Arial, sans-serif; color:#000; padding:18mm; }
  .print-title { font-size:18pt; font-weight:bold; margin-bottom:6mm; }
  .print-meta { font-size:11pt; margin-bottom:8mm; }
  .print-line { border-bottom:1px solid #000; display:inline-block; width:70mm; height:6mm; vertical-align:bottom; margin-left:3mm; }
  .task-block { margin-bottom:8mm; padding-bottom:6mm; border-bottom:1px solid #ddd; }
  .task-head { font-weight:bold; margin-bottom:2mm; }
  .task-text { margin-bottom:4mm; }
  .work-space { height:22mm; border:1px solid #eee; background:#fafafa; }
  .page-break { page-break-before: always; break-before: page; }
</style>
</head>

<body>

<h1>üéì Mathe-Trainer ‚Äì BOA / BBR (Note 4)</h1>

<div id="topbar">
  <select id="mode" onchange="switchMode()">
    <option value="exam">Pr√ºfungsmodus (mit Eingabe)</option>
    <option value="cards">Karteikartenmodus</option>
  </select>

  <select id="level" onchange="onLevelChange()">
    <option value="boa">BOA (reduziert)</option>
    <option value="bbr">BBR (h√∂heres Niveau)</option>
  </select>

  <button onclick="startRound()">üé≤ Zufallsrunde starten</button>
  <button onclick="nextTaskRandom()">‚û°Ô∏è N√§chste Aufgabe (zuf√§llig)</button>
  <button onclick="nextTaskSameType()">üîÅ Gleicher Typ</button>
  <button onclick="toggleSolution()" id="solutionBtn">üìå L√∂sung anzeigen</button>
  <button onclick="exportWorksheetPDF()">üßæ PDF-√úbungsblatt</button>
  <button onclick="resetTrainer()">üîÑ Reset</button>
</div>

<div id="status">Punkte: 0</div>
<div id="progress">Noch keine Runde gestartet.</div>

<div id="card">
  <div id="task">Starte eine Zufallsrunde.</div>

  <div id="answerArea">
    Deine Antwort:
    <input type="text" id="userAnswer" />
    <button onclick="checkAnswer()">Antwort pr√ºfen</button>
  </div>

  <div id="feedback"></div>

  <div id="solution"></div>
</div>

<div id="printArea" style="display:none;"></div>

<script>
/* =========================================================
   STATE
========================================================= */
let currentAnswer = null;
let points = 0;

let roundActive = false;
let taskNumber = 0;
let totalTasks = 10;

let solvedCurrent = false;

// Merkt sich den zuletzt gezogenen Aufgabentyp (f√ºr "Gleicher Typ")
let lastCat = null;
let lastGenIndex = null;

// F√ºr Karteikarten: L√∂sung ist erst ‚Äûaufgedeckt‚Äú, wenn Nutzer klickt
let revealed = false;

/* =========================================================
   UTIL
========================================================= */
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function getLevel() { return document.getElementById("level").value; }
function getMode() { return document.getElementById("mode").value; }

function fmt(n) {
  // ‚Äûsch√∂ne‚Äú Darstellung: Integer ohne Nachkommastellen, sonst max 2
  if (typeof n === "number") {
    if (Number.isInteger(n)) return String(n);
    return (Math.round(n * 100) / 100).toString().replace(".", ",");
  }
  return String(n);
}

/* Einheitliches Rechenweg-Template */
function steps(lines, result) {
  let html = "";
  lines.forEach((line, i) => html += `Schritt ${i + 1}: ${line}<br>`);
  html += `<br><b>Ergebnis: ${fmt(result)}</b>`;
  return html;
}

/* Standard-Task-Objekt */
function genTask(taskHtml, answer, stepLines) {
  return { task: taskHtml, answer, solution: steps(stepLines, answer) };
}

/* =========================================================
   PR√úFUNGS-REALISTISCHE GEWICHTUNG
========================================================= */
const weightedCategories = [
  "rechnen","rechnen","rechnen","rechnen","rechnen",
  "sach","sach","sach","sach","sach",
  "prozent","prozent","prozent","prozent",
  "geometrie","geometrie","geometrie","geometrie",
  "einheiten","einheiten"
];

/* =========================================================
   POOL: Generatoren (BOA/BBR wirkt √ºber getLevel())
   -> 100+ Aufgaben durch viele Generatoren + Array.from()
========================================================= */
const TASKPOOL = {

  rechnen: [
    // Punkt-vor-Strich
    () => {
      const L = getLevel();
      let a = (L === "boa") ? rand(20, 80) : rand(60, 180);
      let b = (L === "boa") ? rand(2, 7) : rand(3, 12);
      let c = (L === "boa") ? rand(2, 6) : rand(3, 10);
      let ans = a - b * c;
      return genTask(
        `Berechne: <b>${a} ‚àí ${b}¬∑${c}</b>`,
        ans,
        [
          `Punkt vor Strich: ${b}¬∑${c} = ${b*c}`,
          `Dann: ${a} ‚àí ${b*c}`,
          `Ausrechnen`
        ]
      );
    },

    // Klammern
    () => {
      const L = getLevel();
      let a = (L === "boa") ? rand(5, 20) : rand(10, 40);
      let b = (L === "boa") ? rand(5, 20) : rand(10, 40);
      let c = (L === "boa") ? rand(2, 6) : rand(3, 10);
      let ans = (a + b) * c;
      return genTask(
        `Berechne: <b>(${a}+${b})¬∑${c}</b>`,
        ans,
        [
          `Klammer zuerst: ${a}+${b} = ${a+b}`,
          `Dann multiplizieren: ${a+b}¬∑${c}`,
          `Ausrechnen`
        ]
      );
    },

    // Division (glatt)
    () => {
      const L = getLevel();
      let b = (L === "boa") ? rand(2, 10) : rand(3, 12);
      let ans = (L === "boa") ? rand(8, 60) : rand(20, 120);
      let a = ans * b;
      return genTask(
        `Berechne: <b>${a} : ${b}</b>`,
        ans,
        [
          `Division: ${a} : ${b}`,
          `Ausrechnen`
        ]
      );
    },

    // Viele Multiplikationen (Zufallsvarianten)
    ...Array.from({ length: 22 }, () => () => {
      const L = getLevel();
      let a = (L === "boa") ? rand(10, 70) : rand(20, 200);
      let b = (L === "boa") ? rand(2, 12) : rand(3, 25);
      let ans = a * b;
      return genTask(
        `Berechne: <b>${a}¬∑${b}</b>`,
        ans,
        [
          `Multiplikation: ${a}¬∑${b}`,
          `Ausrechnen`
        ]
      );
    }),

    // Add/Sub Variationen
    ...Array.from({ length: 10 }, () => () => {
      const L = getLevel();
      let a = (L === "boa") ? rand(50, 300) : rand(200, 1200);
      let b = (L === "boa") ? rand(10, 180) : rand(50, 900);
      let op = (Math.random() < 0.5) ? "+" : "‚àí";
      let ans = (op === "+") ? (a + b) : (a - b);
      return genTask(
        `Berechne: <b>${a} ${op} ${b}</b>`,
        ans,
        [
          `Rechenart: ${op === "+" ? "Addition" : "Subtraktion"}`,
          `${a} ${op} ${b}`,
          `Ausrechnen`
        ]
      );
    }),
  ],

  einheiten: [
    // m -> cm
    () => {
      const L = getLevel();
      let m = (L === "boa") ? rand(1, 12) : rand(2, 35);
      let ans = m * 100;
      return genTask(
        `Rechne um: <b>${m} m = ? cm</b>`,
        ans,
        [
          `Merke: 1 m = 100 cm`,
          `${m}¬∑100`,
          `Ausrechnen`
        ]
      );
    },

    // cm -> m
    () => {
      const L = getLevel();
      let cm = (L === "boa") ? rand(100, 1200) : rand(250, 5000);
      let ans = cm / 100;
      return genTask(
        `Rechne um: <b>${cm} cm = ? m</b>`,
        ans,
        [
          `Merke: 100 cm = 1 m`,
          `${cm} : 100`,
          `Ausrechnen`
        ]
      );
    },

    // kg -> g
    () => {
      const L = getLevel();
      let kg = (L === "boa") ? rand(1, 8) : rand(2, 20);
      let ans = kg * 1000;
      return genTask(
        `Rechne um: <b>${kg} kg = ? g</b>`,
        ans,
        [
          `Merke: 1 kg = 1000 g`,
          `${kg}¬∑1000`,
          `Ausrechnen`
        ]
      );
    },

    // Minuten -> Stunden (auch halbe/viertel Stunden)
    () => {
      const L = getLevel();
      let mins = (L === "boa") ? [60, 90, 120, 150, 180][rand(0,4)]
                              : [75, 105, 135, 165, 195, 225, 255, 285][rand(0,7)];
      let ans = mins / 60;
      return genTask(
        `Rechne um: <b>${mins} min = ? h</b>`,
        ans,
        [
          `Merke: 60 min = 1 h`,
          `${mins} : 60`,
          `Ausrechnen`
        ]
      );
    },

    // Viele weitere Einheiten-Varianten (cm‚Üîm, kg‚Üîg) zur Pool-Vergr√∂√üerung
    ...Array.from({ length: 16 }, () => () => {
      const L = getLevel();
      const variant = rand(1, 3);
      if (variant === 1) {
        let m = (L === "boa") ? rand(1, 15) : rand(5, 60);
        return genTask(
          `Rechne um: <b>${m} m = ? cm</b>`,
          m*100,
          [`1 m = 100 cm`, `${m}¬∑100`, `Ausrechnen`]
        );
      }
      if (variant === 2) {
        let cm = (L === "boa") ? rand(100, 2000) : rand(500, 9000);
        return genTask(
          `Rechne um: <b>${cm} cm = ? m</b>`,
          cm/100,
          [`100 cm = 1 m`, `${cm} : 100`, `Ausrechnen`]
        );
      }
      let kg = (L === "boa") ? rand(1, 9) : rand(5, 35);
      return genTask(
        `Rechne um: <b>${kg} kg = ? g</b>`,
        kg*1000,
        [`1 kg = 1000 g`, `${kg}¬∑1000`, `Ausrechnen`]
      );
    }),
  ],

  geometrie: [
    // Quadrat Umfang
    () => {
      const L = getLevel();
      let a = (L === "boa") ? rand(2, 12) : rand(4, 25);
      let ans = 4 * a;
      return genTask(
        `Quadrat: Seite ${a} cm ‚Üí <b>Umfang</b>?`,
        ans,
        [
          `Formel: U = 4¬∑a`,
          `Einsetzen: U = 4¬∑${a}`,
          `Ausrechnen`
        ]
      );
    },

    // Rechteck Fl√§che
    () => {
      const L = getLevel();
      let l = (L === "boa") ? rand(3, 18) : rand(6, 35);
      let b = (L === "boa") ? rand(2, 14) : rand(4, 28);
      let ans = l * b;
      return genTask(
        `Rechteck: L√§nge ${l} cm, Breite ${b} cm ‚Üí <b>Fl√§che</b>?`,
        ans,
        [
          `Formel: A = l¬∑b`,
          `Einsetzen: A = ${l}¬∑${b}`,
          `Ausrechnen`
        ]
      );
    },

    // Dreieck Fl√§che
    () => {
      const L = getLevel();
      let g = (L === "boa") ? rand(4, 20) : rand(8, 40);
      let h = (L === "boa") ? rand(3, 15) : rand(6, 30);
      let ans = (g*h)/2;
      return genTask(
        `Dreieck: Grundseite ${g} cm, H√∂he ${h} cm ‚Üí <b>Fl√§che</b>?`,
        ans,
        [
          `Formel: A = (g¬∑h)/2`,
          `Einsetzen: A = (${g}¬∑${h})/2`,
          `Ausrechnen`
        ]
      );
    },

    // Kreis Durchmesser
    () => {
      const L = getLevel();
      let r = (L === "boa") ? rand(2, 10) : rand(3, 20);
      let ans = 2 * r;
      return genTask(
        `Kreis: Radius ${r} cm ‚Üí <b>Durchmesser</b>?`,
        ans,
        [
          `Formel: d = 2¬∑r`,
          `Einsetzen: d = 2¬∑${r}`,
          `Ausrechnen`
        ]
      );
    },

    // Viele weitere Geometrie-Varianten
    ...Array.from({ length: 18 }, () => () => {
      const L = getLevel();
      const v = rand(1, 3);
      if (v === 1) {
        let a = (L === "boa") ? rand(2, 15) : rand(5, 30);
        return genTask(
          `Quadrat: Seite ${a} cm ‚Üí <b>Umfang</b>?`,
          4*a,
          [`Formel: U = 4¬∑a`, `Einsetzen: 4¬∑${a}`, `Ausrechnen`]
        );
      }
      if (v === 2) {
        let l = (L === "boa") ? rand(3, 20) : rand(8, 45);
        let b = (L === "boa") ? rand(2, 18) : rand(6, 40);
        return genTask(
          `Rechteck: ${l} cm √ó ${b} cm ‚Üí <b>Umfang</b>?`,
          2*(l+b),
          [`Formel: U = 2¬∑(l+b)`, `Einsetzen: 2¬∑(${l}+${b})`, `Ausrechnen`]
        );
      }
      let r = (L === "boa") ? rand(2, 12) : rand(4, 25);
      return genTask(
        `Kreis: Radius ${r} cm ‚Üí <b>Durchmesser</b>?`,
        2*r,
        [`Formel: d = 2¬∑r`, `Einsetzen: 2¬∑${r}`, `Ausrechnen`]
      );
    }),
  ],

  sach: [
    // Einkauf
    () => {
      const L = getLevel();
      let price = (L === "boa") ? rand(1, 5) : rand(2, 9);
      let amount = (L === "boa") ? rand(2, 10) : rand(4, 18);
      let ans = price * amount;
      return genTask(
        `${amount} Artikel kosten je ${price} ‚Ç¨.<br><b>Gesamtpreis</b>?`,
        ans,
        [
          `Preis pro St√ºck: ${price} ‚Ç¨`,
          `Anzahl: ${amount}`,
          `${amount}¬∑${price}`,
        ]
      );
    },

    // Geschwindigkeit
    () => {
      const L = getLevel();
      let km = (L === "boa") ? rand(30, 200) : rand(80, 420);
      let h  = (L === "boa") ? rand(1, 5)   : rand(2, 7);
      let ans = km / h;
      return genTask(
        `Ein Auto f√§hrt ${km} km in ${h} h.<br><b>Geschwindigkeit (km/h)</b>?`,
        Number(ans.toFixed(1)),
        [
          `Formel: v = s : t`,
          `Einsetzen: v = ${km} : ${h}`,
          `Ausrechnen`
        ]
      );
    },

    // Zeitaufgabe: Ankunft
    () => {
      const L = getLevel();
      let startH = (L === "boa") ? rand(6, 10) : rand(5, 12);
      let dur = (L === "boa") ? rand(15, 90) : rand(25, 150);
      let total = startH*60 + dur;
      let hh = Math.floor(total/60);
      let mm = String(total%60).padStart(2,"0");
      let ans = `${hh}:${mm}`;
      return {
        task: `Ein Bus startet um <b>${startH}:00</b> Uhr und f√§hrt <b>${dur}</b> Minuten.<br><b>Ankunft</b>?`,
        answer: ans,
        solution: steps(
          [
            `Startzeit in Minuten: ${startH}¬∑60 = ${startH*60}`,
            `+ Fahrzeit: ${startH*60} + ${dur} = ${total} Minuten`,
            `Zur√ºck in Uhrzeit: ${hh}:${mm}`
          ],
          ans
        )
      };
    },

    // Viele weitere Sach-Varianten (pro Tag, Strecke etc.)
    ...Array.from({ length: 16 }, () => () => {
      const L = getLevel();
      const v = rand(1, 3);
      if (v === 1) {
        let pages = (L === "boa") ? rand(30, 120) : rand(80, 300);
        let days  = (L === "boa") ? rand(2, 8)    : rand(3, 14);
        let ans = pages / days;
        return genTask(
          `Du liest ${pages} Seiten in ${days} Tagen.<br><b>Wie viele Seiten pro Tag</b>?`,
          Number(ans.toFixed(1)),
          [
            `Formel: pro Tag = Gesamt : Tage`,
            `Einsetzen: ${pages} : ${days}`,
            `Ausrechnen`
          ]
        );
      }
      if (v === 2) {
        let km = (L === "boa") ? rand(20, 120) : rand(60, 300);
        let min = (L === "boa") ? rand(10, 40) : rand(15, 60);
        let factor = (L === "boa") ? 2 : rand(2, 4);
        let ans = min * factor;
        return genTask(
          `Ein Bus f√§hrt ${km} km in ${min} Minuten.<br>Wie lange f√ºr ${km*factor} km?`,
          ans,
          [
            `${km*factor} km = ${factor}¬∑${km} km`,
            `Zeit w√§chst proportional: ${factor}¬∑${min}`,
            `Ausrechnen`
          ]
        );
      }
      let price = (L === "boa") ? rand(2, 6) : rand(5, 15);
      let paid  = (L === "boa") ? rand(10, 50) : rand(20, 120);
      let ans = paid / price;
      return genTask(
        `Ein Ticket kostet ${price} ‚Ç¨. Du bezahlst ${paid} ‚Ç¨.<br><b>Wie viele Tickets</b>?`,
        Number((paid/price).toFixed(2)),
        [
          `Formel: Anzahl = bezahlt : Preis`,
          `Einsetzen: ${paid} : ${price}`,
          `Ausrechnen`
        ]
      );
    }),
  ],

  prozent: [
    // Prozentwert
    () => {
      const L = getLevel();
      let g = (L === "boa") ? rand(80, 250) : rand(120, 600);
      let p = (L === "boa") ? [10,20,25][rand(0,2)] : [10,15,20,25,30,50][rand(0,5)];
      let ans = g * p / 100;
      return genTask(
        `Berechne <b>${p}%</b> von <b>${g}</b>.`,
        Number((Math.round(ans*100)/100).toFixed(2)),
        [
          `Formel: W = G¬∑p/100`,
          `Einsetzen: W = ${g}¬∑${p}/100`,
          `Ausrechnen`
        ]
      );
    },

    // Rabatt
    () => {
      const L = getLevel();
      let price = (L === "boa") ? rand(20, 180) : rand(50, 450);
      let p = (L === "boa") ? 20 : [10,15,20,25,30][rand(0,4)];
      let ans = price * (1 - p/100);
      return genTask(
        `Ein Produkt kostet ${price} ‚Ç¨.<br>${p}% Rabatt ‚Üí <b>neuer Preis</b>?`,
        Number(ans.toFixed(2)),
        [
          `Du zahlst: 100% ‚àí ${p}% = ${100-p}%`,
          `Rechnung: ${price}¬∑${100-p}/100`,
          `Ausrechnen`
        ]
      );
    },

    // Grundwert
    () => {
      const L = getLevel();
      let w = (L === "boa") ? rand(20, 120) : rand(40, 250);
      let p = (L === "boa") ? [10,20,25,50][rand(0,3)] : rand(5, 60);
      let ans = w * 100 / p;
      return genTask(
        `${w} ist ${p}%.<br><b>Wie gro√ü ist der Grundwert</b>?`,
        Number(ans.toFixed(1)),
        [
          `Formel: G = W¬∑100/p`,
          `Einsetzen: G = ${w}¬∑100/${p}`,
          `Ausrechnen`
        ]
      );
    },

    ...Array.from({ length: 14 }, () => () => {
      const L = getLevel();
      let g = (L === "boa") ? rand(100, 300) : rand(150, 700);
      let diff = (L === "boa") ? rand(10, 80) : rand(20, 200);
      let newVal = g + diff;
      let ans = (diff / g) * 100;
      return genTask(
        `Der Preis steigt von ${g} ‚Ç¨ auf ${newVal} ‚Ç¨.<br><b>Wie viel Prozent</b>?`,
        Number(ans.toFixed(1)),
        [
          `Zunahme: ${newVal} ‚àí ${g} = ${diff}`,
          `Formel: p = (Zunahme/Grundwert)¬∑100`,
          `Einsetzen: (${diff}/${g})¬∑100`,
          `Ausrechnen`
        ]
      );
    }),
  ]
};

/* =========================================================
   MODE/UI
========================================================= */
function switchMode() {
  const mode = getMode();
  const answerArea = document.getElementById("answerArea");
  const status = document.getElementById("status");
  const btn = document.getElementById("solutionBtn");

  if (mode === "cards") {
    answerArea.style.display = "none";
    status.style.display = "none";
    btn.textContent = "üìå L√∂sung aufdecken";
  } else {
    answerArea.style.display = "block";
    status.style.display = "block";
    btn.textContent = "üìå L√∂sung anzeigen";
  }

  // aktuelle Karte/L√∂sung zur√ºcksetzen
  revealed = false;
  document.getElementById("solution").style.display = "none";
}

function onLevelChange() {
  // BOA/BBR wirkt sofort ‚Äì wir resetten nicht hart, aber verstecken L√∂sung und Feedback
  revealed = false;
  document.getElementById("solution").style.display = "none";
  document.getElementById("feedback").innerHTML = "";
  // Hinweis: nextTask... zieht automatisch Aufgaben mit neuen Bereichen.
}

/* =========================================================
   ROUND
========================================================= */
function updateStatus() {
  document.getElementById("status").innerHTML = `Punkte: ${points}`;
}

function startRound() {
  points = 0;
  taskNumber = 0;
  roundActive = true;
  solvedCurrent = false;
  updateStatus();
  nextTaskRandom();
}

function finishRound() {
  roundActive = false;
  document.getElementById("task").innerHTML = `üèÅ Runde beendet!`;
  document.getElementById("progress").innerHTML = `Endpunktzahl: ${points} Punkte`;
}

/* =========================================================
   TASK PICKING
========================================================= */
function pickCategoryWeighted() {
  return weightedCategories[rand(0, weightedCategories.length - 1)];
}

function drawTask(cat, genIndex) {
  const list = TASKPOOL[cat];
  const gen = list[genIndex];
  const t = gen();

  lastCat = cat;
  lastGenIndex = genIndex;

  currentAnswer = t.answer;

  // UI reset
  solvedCurrent = false;
  revealed = false;

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML =
    "<b>L√∂sung Schritt-f√ºr-Schritt:</b><br><br>" + (t.solution || "‚Äî");

  document.getElementById("task").innerHTML = `(${cat}) ${t.task}`;
}

/* N√§chste Aufgabe (Kategorie & Typ zuf√§llig) */
function nextTaskRandom() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  taskNumber++;

  const cat = pickCategoryWeighted();
  const genIndex = rand(0, TASKPOOL[cat].length - 1);

  drawTask(cat, genIndex);

  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks}`;
}

/* Weitere Aufgabe gleicher Typ (exakt gleiche Kategorie + gleicher Generator) */
function nextTaskSameType() {
  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }
  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }
  if (lastCat === null || lastGenIndex === null) {
    // falls noch keine Aufgabe da ist: wie random
    nextTaskRandom();
    return;
  }

  taskNumber++;

  drawTask(lastCat, lastGenIndex);

  document.getElementById("progress").innerHTML =
    `Aufgabe ${taskNumber} von ${totalTasks} (gleicher Typ)`;
}

/* =========================================================
   CHECK ANSWER (nur im Pr√ºfungsmodus sinnvoll)
========================================================= */
function normalize(val) {
  return parseFloat(String(val).trim().replace(",", "."));
}

function checkAnswer() {
  if (getMode() === "cards") {
    document.getElementById("feedback").innerHTML = "‚ÑπÔ∏è Karteikartenmodus: Keine Eingabepr√ºfung.";
    return;
  }
  if (solvedCurrent) return;

  const input = document.getElementById("userAnswer").value.trim();

  // Bei Sach-Aufgaben kann answer auch Text sein (z.B. Uhrzeit)
  if (typeof currentAnswer === "string") {
    const ok = input === currentAnswer;
    document.getElementById("feedback").innerHTML = ok
      ? "‚úî Richtig! +3 Punkte"
      : `‚úò Falsch. Richtige L√∂sung: ${currentAnswer}`;
    if (ok) points += 3;
    solvedCurrent = true;
    updateStatus();
    return;
  }

  const userVal = normalize(input);
  if (isNaN(userVal)) {
    document.getElementById("feedback").innerHTML = "‚ö† Bitte eine Zahl eingeben.";
    return;
  }

  if (Math.abs(userVal - currentAnswer) < 0.05) {
    points += 3;
    document.getElementById("feedback").innerHTML = "‚úî Richtig! +3 Punkte";
  } else {
    document.getElementById("feedback").innerHTML = `‚úò Falsch. Richtige L√∂sung: ${fmt(currentAnswer)}`;
  }

  solvedCurrent = true;
  updateStatus();
}

/* =========================================================
   SOLUTION TOGGLE
========================================================= */
function toggleSolution() {
  const sol = document.getElementById("solution");
  const mode = getMode();

  if (mode === "cards") {
    // Karteikarten: erst aufdecken, dann wieder verstecken
    revealed = !revealed;
    sol.style.display = revealed ? "block" : "none";
    return;
  }

  // Pr√ºfungsmodus: einfach anzeigen (kein Zwang zum Toggle, aber ok)
  sol.style.display = (sol.style.display === "block") ? "none" : "block";
}

/* =========================================================
   RESET
========================================================= */
function resetTrainer() {
  points = 0;
  taskNumber = 0;
  roundActive = false;
  solvedCurrent = false;
  lastCat = null;
  lastGenIndex = null;
  revealed = false;

  updateStatus();
  document.getElementById("task").innerHTML = "Starte eine Zufallsrunde.";
  document.getElementById("progress").innerHTML = "Noch keine Runde gestartet.";
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML = "";
}

/* =========================================================
   PDF EXPORT (Aufgaben + L√∂sungen)
========================================================= */
function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function pickTaskFromCategory(cat, genIndex = null) {
  const list = TASKPOOL[cat];
  if (!list || list.length === 0) return null;
  const idx = (genIndex === null) ? rand(0, list.length - 1) : genIndex;
  return list[idx]();
}

function exportWorksheetPDF(tasksCount = 10, includeSolutions = true, avoidDuplicates = true) {
  const level = getLevel();
  const now = new Date();
  const dateStr = now.toLocaleDateString("de-DE");

  const picked = [];
  const seen = new Set();

  let safety = 0;
  while (picked.length < tasksCount && safety < tasksCount * 80) {
    safety++;

    const cat = pickCategoryWeighted();
    const t = pickTaskFromCategory(cat);
    if (!t) continue;

    const signature = (cat + "||" + t.task).replace(/\s+/g, " ").trim();
    if (avoidDuplicates && seen.has(signature)) continue;

    seen.add(signature);
    // KORREKTUR: Syntaxfehler behoben
    picked.push({ cat, t }); // üëà KORREKTUR: { cat, t } statt { cat, .t }
  }

  if (picked.length === 0) {
    alert("Keine Aufgaben gefunden ‚Äì pr√ºfe TASKPOOL.");
    return;
  }

  const title = `Mathe-√úbungsblatt (${level.toUpperCase()})`;
  let html = `
    <div class="print-title">${escapeHtml(title)}</div>
    <div class="print-meta">
      Datum: <span class="print-line"></span> &nbsp;&nbsp;
      Name: <span class="print-line"></span> &nbsp;&nbsp;
      Klasse: <span class="print-line" style="width:30mm;"></span>
      <div style="margin-top:3mm; color:#444;">Erstellt am ${escapeHtml(dateStr)} ‚Äì ${picked.length} Aufgaben</div>
    </div>
  `;

  picked.forEach((item, i) => {
    const t = item.t;
    html += `
      <div class="task-block">
        <div class="task-head">Aufgabe ${i + 1} (${escapeHtml(item.cat)})</div>
        <div class="task-text">${t.task}</div>
        <div class="work-space"></div>
      </div>
    `;
  });

  if (includeSolutions) {
    html += `<div class="page-break"></div>`;
    html += `
      <div class="print-title">L√∂sungen ‚Äì ${escapeHtml(title)}</div>
      <div class="print-meta">Hinweis: Rechenweg Schritt-f√ºr-Schritt.</div>
    `;

    picked.forEach((item, i) => {
      const t = item.t;
      html += `
        <div class="task-block">
          <div class="task-head">L√∂sung zu Aufgabe ${i + 1} (${escapeHtml(item.cat)})</div>
          <div class="task-text"><b>Antwort:</b> ${escapeHtml(fmt(t.answer))}</div>
          <div>${t.solution || "‚Äî"}</div>
        </div>
      `;
    });
  }

  document.getElementById("printArea").innerHTML = html;
  window.print();
}

/* INIT */
switchMode();
updateStatus();
</script>

</body>
</html>
