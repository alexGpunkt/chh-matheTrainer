<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathe Trainer ‚Äì Niveau 11.3 (BBR 1‚Äì2)</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  padding:20px;
}
h1 { text-align:center; margin: 8px 0 14px; }

#topbar { text-align:center; margin-bottom:10px; }
button { padding:10px; font-size:16px; margin:4px; }

#status { text-align:center; font-size:18px; font-weight:bold; margin-bottom:6px; }
#progress { text-align:center; font-size:16px; margin-bottom:10px; }

#card {
  max-width:820px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:10px;
}
#task { font-size:20px; margin-bottom:15px; }
input { font-size:18px; padding:5px; width:220px; }
#feedback { margin-top:10px; font-size:18px; font-weight:bold; }
#solution {
  display:none;
  background:#eef6ff;
  padding:15px;
  border-radius:5px;
  margin-top:15px;
}
</style>

<!-- Externer Aufgabenpool -->
<script src="pool_113.js"></script>
</head>

<body>

<h1>üéì Mathe-Trainer ‚Äì Niveau 11.3</h1>

<div id="topbar">
  <button onclick="startRound()">üé≤ Zufallsrunde starten</button>
  <button onclick="nextTaskRandom()">‚û°Ô∏è N√§chste Aufgabe (zuf√§llig)</button>
  <button onclick="nextTaskSameType()">üîÅ Gleicher Typ</button>
  <button onclick="toggleSolution()">üìå L√∂sung anzeigen</button>
  <button onclick="resetTrainer()">üîÑ Reset</button>
</div>

<div id="status">Punkte: 0</div>
<div id="progress">Noch keine Runde gestartet.</div>

<div id="card">
  <div id="task">Starte eine Zufallsrunde.</div>

  <div>
    Deine Antwort:
    <input type="text" id="userAnswer" />
    <button onclick="checkAnswer()">Antwort pr√ºfen</button>
  </div>

  <div id="feedback"></div>
  <div id="solution"></div>
</div>

<script>

/* ================================
   STATE
================================ */
let currentAnswer = null;
let currentSolution = "";
let points = 0;

let roundActive = false;
let taskNumber = 0;
let totalTasks = 10;

let lastCat = null;
let lastGenIndex = null;


/* ================================
   UTIL
================================ */
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function normalize(val) {
  return parseFloat(String(val).trim().replace(",", "."));
}

function fmt(n) {
  if (Number.isInteger(n)) return String(n);
  return (Math.round(n * 100) / 100).toString().replace(".", ",");
}


/* ================================
   ROUND LOGIC
================================ */
function startRound() {

  if (typeof window.TASKPOOL === "undefined") {
    alert("pool_113.js wurde nicht geladen!");
    return;
  }

  points = 0;
  taskNumber = 0;
  roundActive = true;

  updateStatus();
  nextTaskRandom();
}

function finishRound() {
  roundActive = false;
  document.getElementById("task").innerHTML = "üèÅ Runde beendet!";
  document.getElementById("progress").innerHTML =
    "Endpunktzahl: " + points + " Punkte";
}


/* ================================
   TASK SELECTION (wie 12.2)
================================ */
function pickCategory() {
  const cats = Object.keys(window.TASKPOOL);
  return cats[rand(0, cats.length - 1)];
}

function drawTask(cat, genIndex) {

  const generator = window.TASKPOOL[cat][genIndex];
  const t = generator();

  lastCat = cat;
  lastGenIndex = genIndex;

  currentAnswer = t.answer;
  currentSolution = t.solution || "";

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userAnswer").value = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML =
    "<b>L√∂sung:</b><br><br>" + currentSolution;

  document.getElementById("task").innerHTML =
    "(" + cat + ") " + t.task;
}

function nextTaskRandom() {

  if (!roundActive) {
    alert("Bitte zuerst eine Zufallsrunde starten!");
    return;
  }

  if (taskNumber >= totalTasks) {
    finishRound();
    return;
  }

  taskNumber++;

  const cat = pickCategory();
  const genIndex = rand(0, window.TASKPOOL[cat].length - 1);

  drawTask(cat, genIndex);

  document.getElementById("progress").innerHTML =
    "Aufgabe " + taskNumber + " von " + totalTasks;
}

function nextTaskSameType() {

  if (!roundActive) return;

  if (lastCat === null) {
    nextTaskRandom();
    return;
  }

  drawTask(lastCat, lastGenIndex);

  document.getElementById("progress").innerHTML =
    "Aufgabe " + taskNumber + " von " + totalTasks + " (gleicher Typ)";
}


/* ================================
   CHECK ANSWER
================================ */
function checkAnswer() {

  const input = document.getElementById("userAnswer").value.trim();

  if (typeof currentAnswer === "string") {

    if (input === currentAnswer) {
      points += 3;
      document.getElementById("feedback").innerHTML = "‚úî Richtig!";
    } else {
      document.getElementById("feedback").innerHTML =
        "‚úò Falsch. Richtige L√∂sung: " + currentAnswer;
    }

  } else {

    const userVal = normalize(input);

    if (isNaN(userVal)) {
      document.getElementById("feedback").innerHTML =
        "‚ö† Bitte eine Zahl eingeben.";
      return;
    }

    if (Math.abs(userVal - currentAnswer) < 0.05) {
      points += 3;
      document.getElementById("feedback").innerHTML = "‚úî Richtig!";
    } else {
      document.getElementById("feedback").innerHTML =
        "‚úò Falsch. Richtige L√∂sung: " + fmt(currentAnswer);
    }
  }

  updateStatus();
}


/* ================================
   UI
================================ */
function updateStatus() {
  document.getElementById("status").innerHTML =
    "Punkte: " + points;
}

function toggleSolution() {
  const sol = document.getElementById("solution");
  sol.style.display =
    (sol.style.display === "block") ? "none" : "block";
}

function resetTrainer() {

  points = 0;
  taskNumber = 0;
  roundActive = false;
  lastCat = null;
  lastGenIndex = null;

  updateStatus();

  document.getElementById("task").innerHTML =
    "Starte eine Zufallsrunde.";
  document.getElementById("progress").innerHTML =
    "Noch keine Runde gestartet.";
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("solution").style.display = "none";
  document.getElementById("solution").innerHTML = "";
}

</script>

</body>
</html>
