<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathe Pr√ºfung ‚Äì Niveau 11.3 ‚≠ê</title>

<!-- KEINE globalen Skripte mehr - nur Diagramm-Renderer wird im Modul geladen -->

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}
* {
  box-sizing: border-box;
  touch-action: manipulation;
}
body {
  font-family: system-ui, Arial, sans-serif;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}
h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
  margin-bottom: 10px;
}
#topbar {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
}
button {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: none;
  background: #1976d2;
  color: white;
  cursor: pointer;
}
button:disabled {
  background: #cccccc;
}
#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}
#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
  overflow-y: auto;
  max-height: calc(100vh - 150px);
}
#taskContainer {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}
/* Diagramm-Container */
.diagram-container {
  margin: 15px 0;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
}
.diagram-container svg {
  max-width: 100%;
  height: auto;
}
#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}
.hidden { display: none; }
#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
#navButtons button { flex: 1; }
#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
</style>
</head>

<body>

<h1>üìù Mathematik ‚Äì Pr√ºfungsmodus 11.3 (Note 1‚Äì2)</h1>

<div id="topbar">
  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="taskContainer">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input type="text" id="answer"
           inputmode="decimal"
           placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<!-- =========================
     ES-MODUL L√ñSUNG mit Diagramm-Unterst√ºtzung
========================= -->
<script type="module">

// Diagramm-Skripte dynamisch laden
async function loadDiagramScripts() {
  // Pr√ºfen ob bereits geladen
  if (typeof window.renderDiagram !== 'undefined') return;
  
  // Skripte nacheinander laden
  await import('./staticDiagrams.js');
  await import('./diagramRenderer.js');
}

// POOL_113 importieren
//import POOL_113 from "./pool_113.js";
// RICHTIG - verwende das globale TASKPOOL_113:
window.TASKPOOL = {};

// Direkt das globale Objekt verwenden:
if (typeof window.TASKPOOL_113 !== 'undefined') {
  window.TASKPOOL = window.TASKPOOL_113;
} else {
  console.error('TASKPOOL_113 nicht geladen!');
}
      
/* ============================================
   TASKPOOL AUS DEM MODUL ERZEUGEN
============================================ */
function buildTaskpoolFromModule(mod) {
  const tp = {};
  const raw = mod.pool;

  Object.keys(raw).forEach(key => {
    if (key === "meta") return;
    tp[key] = raw[key].map(taskObj => {
      return function() {
        // Aufgabe mit Diagramm-Unterst√ºtzung
        return {
          task: taskObj.prompt.trim() + "<br><br><b>" +
                taskObj.question.trim() + "</b>",
          answer: extractAnswer(taskObj.solution),
          solution: taskObj.steps || "",
          diagram: taskObj.diagram || null,
          category: key,
          taskObj: taskObj
        };
      };
    });
  });

  return tp;
}

function extractAnswer(sol) {
  const match = sol.match(/[-+]?[0-9]*[.,]?[0-9]+/);
  if (!match) return sol;
  return parseFloat(match[0].replace(",", "."));
}

window.TASKPOOL = buildTaskpoolFromModule(POOL_113);

/* ============================================
   DIAGRAMM-RENDERING (mit dynamischem Laden)
============================================ */
async function renderTaskDiagram(diagramData, container) {
  if (!diagramData || !container) return;
  
  // Sicherstellen, dass Diagramm-Skripte geladen sind
  await loadDiagramScripts();
  
  // Vorhandenes Diagramm entfernen
  const existingDiagram = container.querySelector('.diagram-container');
  if (existingDiagram) existingDiagram.remove();
  
  // Neues Diagramm-Container erstellen
  const diagramContainer = document.createElement('div');
  diagramContainer.className = 'diagram-container';
  
  try {
    // Diagramm rendern (jetzt sollte renderDiagram global verf√ºgbar sein)
    if (typeof window.renderDiagram === 'function') {
      window.renderDiagram(diagramData, diagramContainer);
    } else {
      console.warn('renderDiagram nicht verf√ºgbar');
      diagramContainer.innerHTML = '<p style="color:#999;">[Diagramm konnte nicht geladen werden]</p>';
    }
    
    // Nach dem Aufgaben-Text einf√ºgen
    const taskText = container.querySelector('.task-text');
    if (taskText) {
      taskText.after(diagramContainer);
    } else {
      container.appendChild(diagramContainer);
    }
  } catch (e) {
    console.error('Fehler beim Rendern des Diagramms:', e);
    diagramContainer.innerHTML = '<p style="color:#999;">[Diagramm-Fehler]</p>';
    container.appendChild(diagramContainer);
  }
}

/* ============================================
   PR√úFUNGSLOGIK
============================================ */

const EXAM_TIME = 90 * 60;
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const PASS_POINTS = 24;
const TEACHER_PIN = "1234";

let roundActive = false;
let taskNumber = 0;
let points = 0;
let currentAnswer = null;
let currentTask = null;
let timeLeft = 0;
let timerInt = null;

const startBtnEl  = document.getElementById("startBtn");
const timerEl     = document.getElementById("timer");
const taskContainer = document.getElementById("taskContainer");
const answerAreaEl = document.getElementById("answerArea");
const answerEl    = document.getElementById("answer");
const nextBtnEl   = document.getElementById("nextBtn");
const finishBtnEl = document.getElementById("finishBtn");
const resultEl    = document.getElementById("result");

function rand(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}

function startRound(){
  points = 0;
  taskNumber = 0;
  roundActive = true;
  timeLeft = EXAM_TIME;
  currentTask = null;

  resultEl.innerHTML = "";
  startBtnEl.disabled = true;
  answerAreaEl.classList.remove("hidden");
  timerEl.classList.remove("hidden");

  clearInterval(timerInt);
  timerInt = setInterval(updateTimer,1000);

  nextTaskRandom();
}

async function nextTaskRandom(){
  if(taskNumber >= TASKS_TOTAL){
    finishRound();
    return;
  }

  taskNumber++;

  const cats = Object.keys(window.TASKPOOL);
  const cat = cats[rand(0,cats.length-1)];
  const list = window.TASKPOOL[cat];
  const gen = list[rand(0,list.length-1)];
  const t = gen();

  currentAnswer = t.answer;
  currentTask = t;

  // Task-Container leeren und neu aufbauen
  taskContainer.innerHTML = '';
  
  // Aufgaben-Text
  const taskTextDiv = document.createElement('div');
  taskTextDiv.className = 'task-text';
  taskTextDiv.innerHTML = `<b>Aufgabe ${taskNumber}/${TASKS_TOTAL}</b><br>${t.task}`;
  taskContainer.appendChild(taskTextDiv);
  
  // Diagramm rendern falls vorhanden (async)
  if (t.diagram) {
    await renderTaskDiagram(t.diagram, taskContainer);
  }

  answerEl.value="";
  answerEl.focus();
}

function checkAndScore(){
  const val = parseFloat(answerEl.value.replace(",","."));
  if(!isNaN(val) && Math.abs(val-currentAnswer)<0.05){
    points += POINTS_PER_TASK;
  }
}

function saveAndNext(){
  if(!roundActive) return;
  checkAndScore();
  nextTaskRandom();
}

function finishRound(){
  checkAndScore();

  const pin = prompt("Lehrer-PIN eingeben (Demo: 1234):");
  if(pin!==TEACHER_PIN) return;

  roundActive=false;
  clearInterval(timerInt);

  answerAreaEl.classList.add("hidden");
  timerEl.classList.add("hidden");
  startBtnEl.disabled=false;

  const res = points>=PASS_POINTS?
    "‚úÖ BESTANDEN":"‚ùå NICHT BESTANDEN";

  resultEl.innerHTML =
    `Punkte: <b>${points}/${TASKS_TOTAL*POINTS_PER_TASK}</b><br>${res}`;

  taskContainer.innerHTML = "Pr√ºfung beendet.";
}

function updateTimer(){
  timeLeft--;
  const m=Math.floor(timeLeft/60);
  const s=(timeLeft%60).toString().padStart(2,"0");
  timerEl.innerText=`‚è± ${m}:${s}`;
  if(timeLeft<=0) finishRound();
}

startBtnEl.addEventListener("click",startRound);
nextBtnEl.addEventListener("click",saveAndNext);
finishBtnEl.addEventListener("click",finishRound);

answerEl.addEventListener("keypress",e=>{
  if(e.key==="Enter") saveAndNext();
});

</script>

</body>
</html>

