<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathe Pr√ºfung ‚Äì Niveau 11.3 ‚≠ê (Note 1‚Äì2)</title>

<!-- Diagramm-Skripte und Aufgabenpool -->
<script src="staticDiagrams.js"></script>
<script src="diagramRenderer.js"></script>
<script src="pool_113.js"></script>

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}
* {
  box-sizing: border-box;
  touch-action: manipulation;
}
body {
  font-family: system-ui, Arial, sans-serif;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}
h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
  margin-bottom: 10px;
}
#topbar {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
button, select {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: none;
  background: #1976d2;
  color: white;
  cursor: pointer;
}
select {
  background: white;
  color: #333;
  border: 1px solid #1976d2;
}
button:disabled {
  background: #cccccc;
}
#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}
#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
  overflow-y: auto;
  max-height: calc(100vh - 150px);
}
#taskContainer {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}

/* Diagramm-Container */
.diagram-container {
  margin: 15px 0;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
  min-height: 120px;
}

/* ‚úÖ WICHTIG: SVG braucht feste H√∂he, sonst 0px (height="auto" im Renderer) */
.diagram-container svg {
  width: 100%;
  height: 280px;      /* <- Fix */
  max-width: 100%;
  display: block;
  margin: 0 auto;
}

#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}
.hidden { display: none; }
#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
#navButtons button { flex: 1; }
#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
#categorySelect {
  min-width: 200px;
}
</style>
</head>

<body>

<h1>üìù Mathematik ‚Äì Pr√ºfungsmodus 11.3 (Note 1‚Äì2)</h1>

<div id="topbar">
  <select id="categorySelect">
    <option value="all">Alle Kategorien</option>
  </select>
  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="taskContainer">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input type="text" id="answer"
           inputmode="decimal"
           placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
/* =========================================================
   11.3.html - Pr√ºfungsmodus f√ºr Note 1-2
========================================================= */

const EXAM_TIME = 90 * 60;        // 90 Minuten
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const PASS_POINTS = 24;           // 80% f√ºr Note 1-2
const TEACHER_PIN = "1234";       // Demo-PIN

let roundActive = false;
let points = 0;
let currentAnswer = null;
let currentTask = null;
let timeLeft = 0;
let timerInt = null;

let examTasks = [];
let currentTaskIndex = 0;

let availableCategories = [];

const startBtnEl = document.getElementById("startBtn");
const timerEl = document.getElementById("timer");
const taskContainer = document.getElementById("taskContainer");
const answerAreaEl = document.getElementById("answerArea");
const answerEl = document.getElementById("answer");
const nextBtnEl = document.getElementById("nextBtn");
const finishBtnEl = document.getElementById("finishBtn");
const resultEl = document.getElementById("result");
const categorySelect = document.getElementById("categorySelect");

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function initTaskPool() {
  if (typeof window.TASKPOOL_113 === 'undefined') {
    console.error('TASKPOOL_113 nicht gefunden! pool_113.js wurde nicht korrekt geladen.');
    alert('Fehler: Aufgabenpool konnte nicht geladen werden!');
    return false;
  }
  availableCategories = Object.keys(window.TASKPOOL_113);
  updateCategorySelect();
  return true;
}

function updateCategorySelect() {
  while (categorySelect.options.length > 1) categorySelect.remove(1);

  availableCategories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;

    let displayName = cat
      .replace(/_/g, ' ')
      .replace(/prozent/g, 'Prozent')
      .replace(/zuordnung/g, 'Zuordnung')
      .replace(/pythagoras/g, 'Pythagoras')
      .replace(/koerper/g, 'K√∂rper')
      .replace(/statistik/g, 'Statistik')
      .replace(/gleichungen/g, 'Gleichungen')
      .replace(/flaeche2d/g, 'Fl√§chen')
      .replace(/wahrscheinlichkeit/g, 'Wahrscheinlichkeit')
      .replace(/wachstum/g, 'Wachstum');

    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
    option.textContent = displayName;
    categorySelect.appendChild(option);
  });
}

function getRandomTask() {
  let category = categorySelect.value;

  if (category === 'all' && availableCategories.length > 0) {
    category = availableCategories[rand(0, availableCategories.length - 1)];
  }

  if (!window.TASKPOOL_113[category] || window.TASKPOOL_113[category].length === 0) {
    console.error('Kategorie nicht verf√ºgbar:', category);
    return null;
  }

  const taskList = window.TASKPOOL_113[category];
  const genIndex = rand(0, taskList.length - 1);
  const taskGen = taskList[genIndex];

  const task = taskGen();
  task.category = category;
  task.genIndex = genIndex;
  return task;
}

/* ‚úÖ defensives Diagramm-Rendering */
function renderTaskDiagram(diagramData, hostContainer) {
  if (!diagramData || !hostContainer) return;

  const old = hostContainer.querySelector('.diagram-container');
  if (old) old.remove();

  const wrap = document.createElement('div');
  wrap.className = 'diagram-container';

  try {
    if (typeof window.renderDiagram === 'function') {
      window.renderDiagram(diagramData, wrap, { size: "screen" });
    } else {
      wrap.innerHTML = "‚ö† renderDiagram() nicht gefunden.";
    }

    // Falls der Renderer nichts produziert hat:
    if (!wrap.querySelector("svg") && wrap.innerHTML.trim() === "") {
      wrap.innerHTML = "‚ö† Diagramm konnte nicht gerendert werden.";
    }

  } catch (e) {
    console.error('Fehler beim Rendern des Diagramms:', e);
    wrap.innerHTML = "‚ùå Diagramm-Fehler (siehe Konsole).";
  }

  hostContainer.appendChild(wrap);
}

function startExam() {
  // harter Schutz: Pool muss da sein
  if (!availableCategories.length) {
    const ok = initTaskPool();
    if (!ok) return;
  }

  points = 0;
  currentTaskIndex = 0;
  examTasks = [];
  roundActive = true;
  timeLeft = EXAM_TIME;

  for (let i = 0; i < TASKS_TOTAL; i++) {
    const task = getRandomTask();
    examTasks.push(task || { task: "Fehler: Keine Aufgabe verf√ºgbar", answer: 0, category: "error" });
  }

  resultEl.innerHTML = "";
  startBtnEl.disabled = true;
  categorySelect.disabled = true;
  answerAreaEl.classList.remove("hidden");
  timerEl.classList.remove("hidden");

  clearInterval(timerInt);
  timerInt = setInterval(updateTimer, 1000);

  showCurrentTask();
}

function showCurrentTask() {
  if (!roundActive || !examTasks[currentTaskIndex]) return;

  const task = examTasks[currentTaskIndex];
  currentAnswer = task.answer;
  currentTask = task;

  taskContainer.innerHTML = "";

  const taskTextDiv = document.createElement("div");
  taskTextDiv.className = "task-text";
  taskTextDiv.innerHTML = `<b>Aufgabe ${currentTaskIndex + 1}/${TASKS_TOTAL} (${task.category})</b><br>${task.task}`;
  taskContainer.appendChild(taskTextDiv);

  if (task.diagram) renderTaskDiagram(task.diagram, taskContainer);

  answerEl.value = "";
  answerEl.focus();
}

function checkAndScore() {
  const input = answerEl.value.trim().replace(",", ".");

  if (typeof currentAnswer === "string") {
    if (input.toLowerCase() === currentAnswer.toLowerCase()) points += POINTS_PER_TASK;
    return;
  }

  const val = parseFloat(input);
  if (!isNaN(val) && Math.abs(val - currentAnswer) < 0.05) points += POINTS_PER_TASK;
}

function saveAndNext() {
  if (!roundActive) return;

  checkAndScore();
  currentTaskIndex++;

  if (currentTaskIndex < TASKS_TOTAL) showCurrentTask();
  else finishExam();
}

function finishExam() {
  const pin = prompt("Lehrer-PIN eingeben (Demo: 1234):");
  if (pin !== TEACHER_PIN) {
    alert("Falsche PIN - Pr√ºfung kann nicht abgeschlossen werden.");
    return;
  }

  roundActive = false;
  clearInterval(timerInt);

  answerAreaEl.classList.add("hidden");
  timerEl.classList.add("hidden");
  startBtnEl.disabled = false;
  categorySelect.disabled = false;

  const res = points >= PASS_POINTS ? "‚úÖ BESTANDEN" : "‚ùå NICHT BESTANDEN";
  resultEl.innerHTML = `Punkte: <b>${points} / ${TASKS_TOTAL * POINTS_PER_TASK}</b><br>${res}`;
  taskContainer.innerHTML = "Pr√ºfung beendet. Neustart m√∂glich.";
}

function updateTimer() {
  timeLeft--;
  const m = Math.floor(timeLeft / 60);
  const s = (timeLeft % 60).toString().padStart(2, "0");
  timerEl.innerText = `‚è± ${m}:${s}`;

  if (timeLeft <= 0) finishExam();
}

window.addEventListener("beforeunload", function (e) {
  if (roundActive) {
    e.preventDefault();
    e.returnValue = "Die Pr√ºfung l√§uft noch. Bitte zuerst abgeben.";
  }
});

startBtnEl.addEventListener("click", startExam);
nextBtnEl.addEventListener("click", saveAndNext);
finishBtnEl.addEventListener("click", finishExam);

answerEl.addEventListener("keypress", function(e) {
  if (e.key === "Enter" && roundActive) {
    e.preventDefault();
    saveAndNext();
  }
});

document.addEventListener('DOMContentLoaded', function() {
  initTaskPool();
});
</script>

</body>
</html>
