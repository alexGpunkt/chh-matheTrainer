<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathe Pr√ºfung ‚Äì Niveau 11.3 ‚≠ê (Note 1‚Äì2)</title>

<script src="staticDiagrams.js"></script>
<script src="diagramRenderer.js"></script>
<script src="pool_113.js"></script>

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}
body {
  font-family: system-ui, Arial;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}
h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
}

#topbar {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

button {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: none;
  background: #1976d2;
  color: white;
  cursor: pointer;
}
button:disabled { background: #ccc; }

#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}

#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
  overflow-y: auto;
  max-height: calc(100vh - 150px);
}

#taskContainer {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}

/* ‚úÖ RESPONSIVE DIAGRAMME */
.diagram-container {
  margin: 15px 0;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
}

.diagram-container svg {
  width: 100%;
  height: auto;
  max-height: 45vh;
}

/* Eingabe */
#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}
.hidden { display: none; }

#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
#navButtons button { flex: 1; }

#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
</style>
</head>

<body>

<h1>üìù Mathematik ‚Äì Pr√ºfungsmodus 11.3 (Note 1‚Äì2)</h1>

<div id="topbar">
  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="taskContainer">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input type="text" id="answer" inputmode="decimal"
           placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
const EXAM_TIME = 90 * 60;
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const PASS_POINTS = 24;
const TEACHER_PIN = "1234";

let roundActive = false;
let points = 0;
let currentAnswer = null;
let timeLeft = 0;
let timerInt = null;
let currentTaskIndex = 0;

let availableCategories = [];

function rand(min, max){
  return Math.floor(Math.random()*(max-min+1))+min;
}

function initPool(){
  availableCategories = Object.keys(window.TASKPOOL_113 || {});
}

function getRandomTask(){
  const cat = availableCategories[rand(0, availableCategories.length-1)];
  const list = TASKPOOL_113[cat];
  const gen = list[rand(0, list.length-1)];
  const task = gen();
  task.category = cat;
  return task;
}

function renderTask(task){
  const container = document.getElementById("taskContainer");
  container.innerHTML = `<b>Aufgabe ${currentTaskIndex+1}/${TASKS_TOTAL}</b><br>${task.task}`;

  if(task.diagram){
    const wrap = document.createElement("div");
    wrap.className="diagram-container";
    renderDiagram(task.diagram, wrap);
    container.appendChild(wrap);
  }

  currentAnswer = task.answer;
}

function startExam(){
  points=0;
  currentTaskIndex=0;
  roundActive=true;
  timeLeft=EXAM_TIME;

  document.getElementById("result").innerHTML="";
  document.getElementById("answerArea").classList.remove("hidden");
  document.getElementById("timer").classList.remove("hidden");

  nextTask();
  timerInt=setInterval(updateTimer,1000);
}

function nextTask(){
  if(currentTaskIndex>=TASKS_TOTAL){
    finishExam();
    return;
  }
  const task = getRandomTask();
  renderTask(task);
  document.getElementById("answer").value="";
  document.getElementById("answer").focus();
}

function saveAndNext(){
  const val=parseFloat(document.getElementById("answer").value.replace(",","."));
  if(!isNaN(val)&&Math.abs(val-currentAnswer)<0.05){
    points+=POINTS_PER_TASK;
  }
  currentTaskIndex++;
  nextTask();
}

function finishExam(){
  const pin=prompt("Lehrer-PIN eingeben:");
  if(pin!==TEACHER_PIN) return;

  roundActive=false;
  clearInterval(timerInt);

  document.getElementById("answerArea").classList.add("hidden");
  document.getElementById("timer").classList.add("hidden");

  const res = points>=PASS_POINTS ? "‚úÖ BESTANDEN" : "‚ùå NICHT BESTANDEN";
  document.getElementById("result").innerHTML=
    `Punkte: ${points}/${TASKS_TOTAL*POINTS_PER_TASK}<br>${res}`;
}

function updateTimer(){
  timeLeft--;
  const m=Math.floor(timeLeft/60);
  const s=(timeLeft%60).toString().padStart(2,"0");
  document.getElementById("timer").innerText=`‚è± ${m}:${s}`;
  if(timeLeft<=0) finishExam();
}

document.getElementById("startBtn").onclick=startExam;
document.getElementById("nextBtn").onclick=saveAndNext;
document.getElementById("finishBtn").onclick=finishExam;

document.addEventListener("DOMContentLoaded", initPool);
</script>

</body>
</html>
