<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mathematik ‚Äì BBR Pr√ºfungsmodus (Note 1‚Äì2)</title>

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}
* {
  box-sizing: border-box;
  touch-action: manipulation;
}
body {
  font-family: system-ui, Arial, sans-serif;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}
h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
  margin-bottom: 10px;
}
#topbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
}
select, button, label {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #999;
}
button {
  background: #1976d2;
  color: white;
  border: none;
  cursor: pointer;
}
button:active {
  background: #0d47a1;
}
button:disabled {
  background: #cccccc;
  cursor: not-allowed;
}
#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}
#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
}
#task {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}
#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}
.hidden { display: none; }
#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
#navButtons button { flex: 1; }
#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
</style>
<!-- Aufgabenpool als externe JS-Datei -->
<script src="pool_113.js"></script>
</head>

<body>

<h1>üìù Mathematik ‚Äì BBR Pr√ºfungsmodus (Note 1‚Äì2)</h1>

<div id="topbar">
  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="task">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input id="answer" type="text" inputmode="decimal" placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
/* =====================
   BASIS - NUR PR√úFUNGSLOGIK
   Aufgabenpool wird aus pool_113.js importiert
===================== */
const EXAM_TIME = 90 * 60;     // 90 Minuten
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const TOTAL_POINTS = TASKS_TOTAL * POINTS_PER_TASK;
// ‚ö†Ô∏è WICHTIG: Diese PIN ist im Quellcode sichtbar!
// F√ºr echten Einsatz sollte die PIN serverseitig validiert werden.
const TEACHER_PIN = "1234"; // ‚ö†Ô∏è NUR ZU DEMONSTRATIONSZWECKEN

/* =====================
   HILFSFUNKTIONEN
   parseNum f√ºr Eingabe
===================== */
function parseNum(v) {
  if (!v) return NaN;
  return parseFloat(v.replace(",", "."));
}

/* =====================
   STATE
===================== */
let tasks = [];
let current = 0;
let points = 0;
let timeLeft = 0;
let timerInt = null;
let running = false;

// Speichert bereits verwendete Aufgabentypen f√ºr mehr Abwechslung
let usedGenerators = [];

/* =====================
   PR√úFUNG - UI-LOGIK
===================== */
function startExam() {
  console.log("=== Pr√ºfung wird gestartet ===");
  
  // DOM-Reset
  tasks = [];
  current = 0;
  points = 0;
  timeLeft = EXAM_TIME;
  running = true;
  usedGenerators = [];

  // Pr√ºfen ob pool_113.js geladen wurde
  if (typeof getTask113 === 'undefined') {
    console.error("pool_113.js nicht geladen!");
    alert("Fehler: Aufgabenpool konnte nicht geladen werden!");
    return;
  }

  // Aufgaben generieren - mit Zufallsindex f√ºr echte Zuf√§lligkeit
  for (let i = 0; i < TASKS_TOTAL; i++) {
    try {
      // ‚úÖ Feste Reihenfolge der Kategorien, aber ZUF√ÑLLIGE Aufgaben daraus
      // Statt festen Index zu verwenden, generieren wir einen zuf√§lligen Index
      // innerhalb der Kategorie f√ºr mehr Abwechslung
      
      // Kategorie aus fester Reihenfolge (pr√ºfungsnah)
      const cat = getExamCategoryByIndex(i);
      
      // Zuf√§llige Aufgabe aus dieser Kategorie
      const task = getRandomTaskFromCategory(cat);
      
      tasks.push(task);
      console.log(`Aufgabe ${i+1}: Kategorie ${cat} - generiert`);
    } catch (error) {
      console.error("Fehler beim Generieren der Aufgabe", i, error);
      // Fallback-Aufgabe
      tasks.push({
        text: `Berechne: ${Math.floor(Math.random() * 90 + 10)} + ${Math.floor(Math.random() * 90 + 10)}`,
        sol: Math.floor(Math.random() * 180 + 20)
      });
    }
  }

  console.log(`${tasks.length} Aufgaben generiert`);

  // UI aktualisieren
  document.getElementById("answerArea").classList.remove("hidden");
  document.getElementById("timer").classList.remove("hidden");
  document.getElementById("result").innerHTML = "";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("answer").value = "";

  // Timer starten
  clearInterval(timerInt);
  timerInt = setInterval(updateTimer, 1000);
  
  // Erste Aufgabe anzeigen
  showTask();
}

/**
 * Gibt die Kategorie f√ºr einen bestimmten Index in der Pr√ºfungsreihenfolge zur√ºck
 */
function getExamCategoryByIndex(idx) {
  // Feste, ausgewogene Reihenfolge der Kategorien f√ºr die Pr√ºfung
  const examOrder = [
    "rechnen",
    "prozent",
    "geometrie",
    "koerper",
    "pythagoras",
    "zylinder",
    "sach",
    "rechnen",
    "prozent",
    "koerper"
  ];
  
  return examOrder[idx % examOrder.length];
}

/**
 * Holt eine ZUF√ÑLLIGE Aufgabe aus einer bestimmten Kategorie
 * Das ist der Schl√ºssel zur L√∂sung des Problems!
 */
function getRandomTaskFromCategory(cat) {
  // Pr√ºfen ob Kategorie existiert
  const poolSize = getTaskPoolSize(cat);
  
  if (!poolSize || poolSize === 0) {
    console.warn(`Kategorie ${cat} hat keine Aufgaben, verwende Fallback`);
    // Fallback auf rechnen
    const fallbackSize = getTaskPoolSize("rechnen");
    const randomIndex = Math.floor(Math.random() * fallbackSize);
    const task = getTask113({ 
      category: "rechnen", 
      generatorIndex: randomIndex 
    });
    return task;
  }
  
  // ‚úÖ ZUF√ÑLLIGEN Generator-Index ausw√§hlen (NICHT den Index der Aufgabennummer!)
  const randomIndex = Math.floor(Math.random() * poolSize);
  
  // Aufgabe mit diesem zuf√§lligen Generator holen
  const task = getTask113({ 
    category: cat, 
    generatorIndex: randomIndex 
  });
  
  return task;
}

function showTask() {
  if (current >= tasks.length) {
    finishExam();
    return;
  }
  
  const task = tasks[current];
  document.getElementById("task").innerHTML =
    `<b>Aufgabe ${current+1}/${TASKS_TOTAL}</b><br>${task.text}`;
  document.getElementById("answer").value = "";
  document.getElementById("answer").focus();
  
  console.log(`Zeige Aufgabe ${current+1}: ${task.text.substring(0, 50)}...`);
}

function saveAnswer() {
  const answerInput = document.getElementById("answer");
  const v = parseNum(answerInput.value);
  
  if (isNaN(v)) return false;
  
  const task = tasks[current];
  if (!task || typeof task.sol === 'undefined') return false;
  
  // Toleranz f√ºr Gleitkommazahlen
  const tolerance = Math.max(0.05, Math.abs(task.sol) * 0.01);
  const correct = Math.abs(v - task.sol) <= tolerance;
  
  if (correct) {
    points += POINTS_PER_TASK;
    console.log(`‚úì Aufgabe ${current+1} richtig: ${v} = ${task.sol}`);
  } else {
    console.log(`‚úó Aufgabe ${current+1} falsch: ${v} ‚â† ${task.sol}`);
  }
  
  return correct;
}

function nextTask() {
  // Antwort speichern und Punkte vergeben
  saveAnswer();
  
  // N√§chste Aufgabe
  current++;
  
  if (current < TASKS_TOTAL) {
    showTask();
  } else {
    finishExam();
  }
}

function finishExam() {
  console.log("Pr√ºfung wird beendet");
  
  // Timer stoppen
  clearInterval(timerInt);
  running = false;

  // Letzte Aufgabe auswerten, falls noch nicht geschehen
  if (current < TASKS_TOTAL) {
    saveAnswer();
  }

  // PIN abfragen (nur f√ºr Lehrer)
  const pin = prompt("Lehrer-PIN eingeben (Demo: 1234):");
  if (pin !== TEACHER_PIN) {
    alert("Falsche PIN - Pr√ºfung kann nicht abgeschlossen werden.");
    
    // Reset-UI
    document.getElementById("answerArea").classList.add("hidden");
    document.getElementById("timer").classList.add("hidden");
    document.getElementById("startBtn").disabled = false;
    document.getElementById("result").innerHTML = 
      `‚ùå Pr√ºfung abgebrochen - Falsche PIN`;
    
    return;
  }

  // Note berechnen
  const pct = Math.round(points / TOTAL_POINTS * 100);
  let note = "3";
  let noteText = "";
  
  if (pct >= 92) { 
    note = "1"; 
    noteText = "sehr gut"; 
  } else if (pct >= 80) { 
    note = "2"; 
    noteText = "gut"; 
  } else if (pct >= 67) { 
    note = "3"; 
    noteText = "befriedigend"; 
  } else if (pct >= 50) { 
    note = "4"; 
    noteText = "ausreichend"; 
  } else { 
    note = "5"; 
    noteText = "mangelhaft"; 
  }

  // UI aktualisieren
  document.getElementById("answerArea").classList.add("hidden");
  document.getElementById("timer").classList.add("hidden");
  document.getElementById("result").innerHTML = `
    <div style="background: #f0f8ff; padding: 20px; border-radius: 12px; border: 2px solid #1976d2;">
      <h2 style="margin-top: 0; color: #1976d2;">Pr√ºfung abgeschlossen</h2>
      <div style="font-size: 1.5rem; margin: 15px 0;">
        Punkte: <b>${points}/${TOTAL_POINTS}</b> (${pct}%)
      </div>
      <div style="font-size: 1.8rem; font-weight: bold; color: #1976d2;">
        Note: ${note} (${noteText})
      </div>
    </div>
  `;
  
  // Button wieder aktivieren
  document.getElementById("startBtn").disabled = false;
}

/* =====================
   TIMER
===================== */
function updateTimer() {
  if (!running) return;
  
  timeLeft--;
  
  if (timeLeft <= 0) {
    document.getElementById("timer").innerText = `‚è± 0:00 - Zeit abgelaufen!`;
    finishExam();
    return;
  }
  
  const m = Math.floor(timeLeft/60);
  const s = String(timeLeft%60).padStart(2,"0");
  document.getElementById("timer").innerText = `‚è± ${m}:${s}`;
  
  // Warnung bei weniger als 5 Minuten
  if (timeLeft < 300) {
    document.getElementById("timer").style.color = "#ff0000";
    document.getElementById("timer").style.fontWeight = "bold";
  }
}

/* =====================
   EVENTS
===================== */
document.addEventListener("DOMContentLoaded", function() {
  console.log("11.3.html geladen, initialisiere...");
  
  const startBtn = document.getElementById("startBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const answerInput = document.getElementById("answer");
  
  // Pr√ºfen ob pool_113.js geladen wurde
  if (typeof getTask113 === 'undefined') {
    console.error("pool_113.js nicht geladen!");
    alert("Fehler: Aufgabenpool konnte nicht geladen werden! Stellen Sie sicher, dass pool_113.js im gleichen Ordner liegt.");
  } else {
    console.log("pool_113.js erfolgreich geladen");
    console.log("Verf√ºgbare Kategorien:", getAvailableCategories ? getAvailableCategories() : "nicht verf√ºgbar");
  }
  
  if (startBtn) {
    startBtn.addEventListener("click", startExam);
  }
  
  if (nextBtn) {
    nextBtn.addEventListener("click", nextTask);
  }
  
  if (finishBtn) {
    finishBtn.addEventListener("click", finishExam);
  }
  
  // Enter-Taste f√ºr Antwort
  if (answerInput) {
    answerInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        nextTask();
      }
    });
  }
  
  // Verhindern des Scrollens bei Eingabe auf mobilen Ger√§ten
  if (answerInput) {
    answerInput.addEventListener("touchstart", function(e) {
      e.stopPropagation();
    });
  }
});

/* =====================
   FALLBACK-Funktionen falls pool_113.js nicht geladen wurde
===================== */
function getTask113(config) {
  console.warn("Fallback: getTask113 wird verwendet");
  if (config && config.category && config.generatorIndex !== undefined) {
    // Versuche aus TASKPOOL zu laden
    if (typeof window.TASKPOOL !== 'undefined' && window.TASKPOOL[config.category]) {
      const pool = window.TASKPOOL[config.category];
      const idx = config.generatorIndex % pool.length;
      const task = pool[idx]();
      return {
        text: task.task,
        sol: task.answer
      };
    }
  }
  
  // Absoluter Fallback
  const x = Math.floor(Math.random() * 10) + 5;
  return {
    text: `Berechne: 2¬∑(${x} + 3) - 4`,
    sol: 2 * (x + 3) - 4
  };
}

function getTaskPoolSize(cat) {
  if (typeof window.TASKPOOL !== 'undefined' && window.TASKPOOL[cat]) {
    return window.TASKPOOL[cat].length;
  }
  return 5; // Fallback
}

function getAvailableCategories() {
  if (typeof window.TASKPOOL !== 'undefined') {
    return Object.keys(window.TASKPOOL);
  }
  return ["rechnen", "prozent", "geometrie", "koerper", "pythagoras", "zylinder", "sach"];
}
</script>

</body>
</html>
