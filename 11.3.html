<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathematik ‚Äì BBR Pr√ºfungsmodus (Note 1‚Äì2)</title>

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}
* {
  box-sizing: border-box;
  touch-action: manipulation;
}
body {
  font-family: system-ui, Arial, sans-serif;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}
h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
  margin-bottom: 10px;
}
#topbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
}
select, button, label {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #999;
}
button {
  background: #1976d2;
  color: white;
  border: none;
  cursor: pointer;
}
button:active {
  background: #0d47a1;
}
button:disabled {
  background: #cccccc;
  cursor: not-allowed;
}
#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}
#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
}
#task {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}
#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}
.hidden { display: none; }
#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
#navButtons button { flex: 1; }
#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
</style>
</head>

<body>

<h1>üìù Mathematik ‚Äì BBR Pr√ºfungsmodus (Note 1‚Äì2)</h1>

<div id="topbar">
  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="task">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input id="answer" type="text" inputmode="decimal" placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
/* =====================
   BASIS
===================== */
const EXAM_TIME = 90 * 60;
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const TOTAL_POINTS = TASKS_TOTAL * POINTS_PER_TASK;
// ‚ö†Ô∏è WICHTIG: Diese PIN ist im Quellcode sichtbar!
// F√ºr echten Einsatz sollte die PIN serverseitig validiert werden.
const TEACHER_PIN = "1234"; // ‚ö†Ô∏è NUR ZU DEMONSTRATIONSZWECKEN

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function round2(x) {
  return Math.round(x * 100) / 100;
}
function parseNum(v) {
  if (!v) return NaN;
  return parseFloat(v.replace(",", "."));
}

/* =====================
   STATE
===================== */
let tasks = [];
let current = 0;
let points = 0;
let timeLeft = 0;
let timerInt = null;
let running = false;

/* =====================
   ERWEITERTER AUFGABENPOOL (100 % BBR)
===================== */
function hardTask(idx) {

  const POOL = {

    /* =====================
       ALGEBRA (4 Aufgaben)
    ===================== */
    algebra: [
      () => {
        const x = rand(-5, 10);
        return {
          text: `Berechne den Wert des Terms f√ºr x = ${x}:<br>3¬∑(2x ‚àí 5) ‚àí (x + 7)`,
          sol: 3*(2*x-5)-(x+7)
        };
      },
      () => {
        const sol = rand(-6, 12);
        return {
          text: `Bestimme x:<br>2(x ‚àí 4) + 6 = ${2*(sol-4)+6}`,
          sol
        };
      },
      () => {
        const a = rand(2, 8);
        const b = rand(3, 10);
        const c = rand(1, 6);
        const x = rand(-3, 5);
        return {
          text: `Berechne f√ºr x = ${x}:<br>${a}x¬≤ + ${b}x + ${c}`,
          sol: a*x*x + b*x + c
        };
      },
      () => {
        const x = rand(2, 10);
        const y = rand(2, 10);
        return {
          text: `Vereinfache den Ausdruck:<br>(${x}x + ${y}) + (${2*x}x - ${y})`,
          sol: 3*x
        };
      }
    ],

    /* =====================
       PROZENT / ZINS (4 Aufgaben)
    ===================== */
    prozent: [
      () => {
        const g = rand(120, 500);
        const p = rand(10, 30);
        return {
          text: `Berechne ${p}% von ${g}.`,
          sol: round2(g*p/100)
        };
      },
      () => {
        const g = rand(200, 800);
        const p = rand(15, 40);
        const neuerPreis = round2(g * (1 - p/100));
        return {
          text: `Ein Preis von ${g} ‚Ç¨ wird um ${p}% reduziert. Neuer Preis?`,
          sol: neuerPreis
        };
      },
      () => {
        const alt = rand(150, 400);
        const neu = alt + rand(30, 100);
        const prozent = round2(((neu - alt) / alt) * 100);
        return {
          text: `Preis steigt von ${alt} ‚Ç¨ auf ${neu} ‚Ç¨. Prozentuale Steigerung?`,
          sol: prozent
        };
      },
      () => {
        const g = rand(300, 700);
        const p1 = rand(10, 20);
        const p2 = rand(5, 15);
        const ans = round2(g * (1 - p1/100) * (1 + p2/100));
        return {
          text: `Preis: ${g} ‚Ç¨, erst ${p1}% Rabatt, dann ${p2}% Steuer. Endpreis?`,
          sol: ans
        };
      }
    ],

    /* =====================
       EBENE GEOMETRIE (4 Aufgaben)
    ===================== */
    geometrie: [
      () => {
        const a = rand(6, 15), b = rand(8, 20);
        return {
          text: `Bestimme die L√§nge der Hypotenuse eines rechtwinkligen Dreiecks mit Katheten ${a} cm und ${b} cm.`,
          sol: round2(Math.sqrt(a*a+b*b))
        };
      },
      () => {
        const a = rand(8, 20);
        const b = rand(10, 25);
        return {
          text: `Rechteck: L√§nge ${a} cm, Breite ${b} cm. Berechne die Fl√§che.`,
          sol: a*b
        };
      },
      () => {
        const r = rand(5, 12);
        return {
          text: `Kreis: Radius ${r} cm. Berechne den Umfang (œÄ ‚âà 3,14).`,
          sol: round2(2 * 3.14 * r)
        };
      },
      () => {
        const g = rand(8, 18);
        const h = rand(6, 15);
        return {
          text: `Dreieck: Grundseite ${g} cm, H√∂he ${h} cm. Berechne die Fl√§che.`,
          sol: round2(g*h/2)
        };
      }
    ],

    /* =====================
       K√ñRPER ‚Äì PRISMEN (4 Aufgaben)
    ===================== */
    koerper: [
      // Prisma mit rechteckiger Grundfl√§che ‚Äì Volumen
      () => {
        const a = rand(4, 10);
        const b = rand(5, 14);
        const h = rand(6, 18);
        return {
          text: `Ein Prisma hat eine rechteckige Grundfl√§che mit a = ${a} cm und b = ${b} cm sowie die H√∂he h = ${h} cm.<br>
                 Berechne das Volumen des Prismas.`,
          sol: a*b*h
        };
      },
      // Prisma mit quadratischer Grundfl√§che ‚Äì Oberfl√§che
      () => {
        const a = rand(4, 10);
        const h = rand(6, 18);
        return {
          text: `Ein Prisma hat eine quadratische Grundfl√§che mit a = ${a} cm und die H√∂he h = ${h} cm.<br>
                 Berechne die Oberfl√§che des Prismas.`,
          sol: 2*a*a + 4*a*h
        };
      },
      // Prisma mit dreieckiger Grundfl√§che ‚Äì Volumen
      () => {
        const g = rand(6, 14);
        const hD = rand(4, 10);
        const hP = rand(8, 20);
        return {
          text: `Ein Prisma besitzt eine dreieckige Grundfl√§che mit Grundseite g = ${g} cm und H√∂he h = ${hD} cm.<br>
                 Die H√∂he des Prismas betr√§gt ${hP} cm.<br>
                 Berechne das Volumen des Prismas.`,
          sol: round2((g*hD/2)*hP)
        };
      },
      // Prisma ‚Äì komplexere Berechnung (KORREKTUR: Direkter Wert statt Funktion)
      () => {
        const a = rand(3, 8);
        const b = rand(4, 10);
        const c = rand(5, 12);
        const h = rand(7, 15);
        const s = (a+b+c)/2;
        const G = Math.sqrt(s*(s-a)*(s-b)*(s-c));
        return {
          text: `Ein Prisma hat eine dreiseitige Grundfl√§che mit Seiten: a=${a} cm, b=${b} cm, c=${c} cm.<br>
                 H√∂he h = ${h} cm. Berechne das Volumen.`,
          sol: round2(G*h)
        };
      }
    ],

    /* =====================
       PYTHAGORAS AN K√ñRPERN (4 Aufgaben)
    ===================== */
    pythagoras: [
      // Raumdiagonale im Quader
      () => {
        const a = rand(4, 10);
        const b = rand(5, 12);
        const h = rand(6, 14);
        return {
          text: `Ein Quader hat die Kantenl√§ngen a = ${a} cm, b = ${b} cm und h = ${h} cm.<br>
                 Bestimme die L√§nge der Raumdiagonale.`,
          sol: round2(Math.sqrt(a*a + b*b + h*h))
        };
      },
      // Seitenh√∂he im Prisma
      () => {
        const a = rand(4, 10);
        const h = rand(6, 14);
        return {
          text: `Ein Prisma hat eine quadratische Grundfl√§che mit a = ${a} cm und H√∂he h = ${h} cm.<br>
                 Bestimme die L√§nge der Seitenkante (Pythagoras).`,
          sol: round2(Math.sqrt(a*a + h*h))
        };
      },
      // K√∂rperdiagonale komplex
      () => {
        const l = rand(5, 12);
        const w = rand(4, 10);
        const h = rand(7, 15);
        return {
          text: `Berechne die Raumdiagonale eines Quaders: L√§nge ${l} cm, Breite ${w} cm, H√∂he ${h} cm.`,
          sol: round2(Math.sqrt(l*l + w*w + h*h))
        };
      },
      // Pyramide H√∂he berechnen (KORREKTUR: Direkter Wert statt Funktion)
      () => {
        const s = rand(6, 12); // Seitenl√§nge Grundfl√§che
        const d = rand(8, 16); // Seitenkante
        const h = round2(Math.sqrt(d*d - (s*Math.sqrt(2)/2)*(s*Math.sqrt(2)/2)));
        return {
          text: `Eine quadratische Pyramide hat Grundkante ${s} cm und Seitenkante ${d} cm.<br>
                 Berechne die H√∂he der Pyramide.`,
          sol: round2(h)
        };
      }
    ],

    /* =====================
       ZYLINDER (4 Aufgaben)
    ===================== */
    zylinder: [
      // Volumen
      () => {
        const r = rand(3, 8);
        const h = rand(8, 20);
        return {
          text: `Ein Zylinder hat den Radius r = ${r} cm und die H√∂he h = ${h} cm.<br>
                 Berechne das Volumen des Zylinders. (œÄ ‚âà 3,14)`,
          sol: round2(3.14*r*r*h)
        };
      },
      // Mantellinie mit Pythagoras
      () => {
        const r = rand(3, 8);
        const h = rand(8, 20);
        const u = round2(2*3.14*r);
        const diag = round2(Math.sqrt(u*u + h*h));
        return {
          text: `Ein Zylinder wird aufgeschnitten und der Mantel als Rechteck dargestellt.<br>
                 Radius r = ${r} cm, H√∂he h = ${h} cm.<br>
                 Bestimme die L√§nge der Diagonale dieses Rechtecks (Pythagoras).`,
          sol: diag
        };
      },
      // Oberfl√§che
      () => {
        const r = rand(4, 10);
        const h = rand(6, 18);
        return {
          text: `Berechne die Oberfl√§che eines Zylinders mit Radius r = ${r} cm und H√∂he h = ${h} cm.<br>
                 (œÄ ‚âà 3,14)`,
          sol: round2(2*3.14*r*r + 2*3.14*r*h)
        };
      },
      // Volumen aus Umfang (KORREKTUR: Direkter Wert statt Funktion)
      () => {
        const u = rand(25, 60);
        const h = rand(10, 25);
        const r = u/(2*3.14);
        const vol = round2(3.14*r*r*h);
        return {
          text: `Ein Zylinder hat einen Umfang von ${u} cm und H√∂he ${h} cm.<br>
                 Berechne das Volumen. (œÄ ‚âà 3,14)`,
          sol: vol
        };
      }
    ],

    /* =====================
       SACH- & ANWENDUNGSAUFGABEN (4 Aufgaben)
    ===================== */
    sach: [
      // Geschwindigkeit
      () => {
        const km = rand(80, 420);
        const h  = rand(2, 7);
        const ans = round2(km / h);
        return {
          text: `Ein Auto f√§hrt ${km} km in ${h} h.<br>
                 Berechne die Durchschnittsgeschwindigkeit in km/h.`,
          sol: ans
        };
      },
      // Zeitrechnung komplexer
      () => {
        const startH = rand(8, 14);
        const durMin = rand(85, 240);
        const total = startH*60 + durMin;
        const hh = Math.floor(total/60) % 24;
        const mm = String(total%60).padStart(2,"0");
        const ans = `${hh}:${mm}`;
        return {
          text: `Ein Zug startet um <b>${startH}:00</b> Uhr und f√§hrt <b>${durMin}</b> Minuten.<br>
                 Ankunftszeit?`,
          sol: ans
        };
      },
      // Mischungsaufgabe
      () => {
        const c1 = rand(10, 30);
        const m1 = rand(100, 300);
        const c2 = rand(40, 60);
        const m2 = rand(50, 150);
        const gesamt = m1 + m2;
        const konz = round2((c1*m1 + c2*m2) / gesamt);
        return {
          text: `${m1}g einer ${c1}%igen L√∂sung werden mit ${m2}g einer ${c2}%igen L√∂sung gemischt.<br>
                 Konzentration der Mischung?`,
          sol: konz
        };
      },
      // Skalierung/Verh√§ltnis
      () => {
        const real = rand(20, 100);
        const scale = rand(10, 50);
        const map = round2(real/scale);
        return {
          text: `Im Ma√üstab 1:${scale} entspricht ${map} cm auf der Karte wie vielen Metern in Wirklichkeit?`,
          sol: real
        };
      }
    ]
  };

  // Feste Reihenfolge der Kategorien (pr√ºfungsnah & ausgewogen)
  const cats = [
    "algebra",
    "prozent",
    "geometrie",
    "koerper",
    "pythagoras",
    "zylinder",
    "sach",
    "algebra",      // Wiederholung f√ºr mehr Vielfalt
    "prozent",
    "koerper"
  ];

  const cat = cats[idx % cats.length];
  
  // Sicherstellen, dass die Kategorie existiert
  if (!POOL[cat] || POOL[cat].length === 0) {
    // Fallback auf algebra
    const algebraList = POOL.algebra;
    return algebraList[rand(0, algebraList.length - 1)]();
  }
  
  const catList = POOL[cat];
  const taskGenerator = catList[rand(0, catList.length - 1)];
  
  // Generator aufrufen und Ergebnis zur√ºckgeben
  return taskGenerator();
}

/* =====================
   PR√úFUNG
===================== */
function startExam() {
  console.log("Pr√ºfung wird gestartet...");
  
  // DOM-Reset
  tasks = [];
  current = 0;
  points = 0;
  timeLeft = EXAM_TIME;
  running = true;

  // Aufgaben generieren
  for (let i = 0; i < TASKS_TOTAL; i++) {
    try {
      const task = hardTask(i);
      tasks.push(task);
    } catch (error) {
      console.error("Fehler beim Generieren der Aufgabe", i, error);
      // Fallback-Aufgabe
      tasks.push({
        text: `Berechne: ${rand(10, 100)} + ${rand(10, 100)}`,
        sol: rand(20, 200)
      });
    }
  }

  console.log(`${tasks.length} Aufgaben generiert`);

  // UI aktualisieren
  document.getElementById("answerArea").classList.remove("hidden");
  document.getElementById("timer").classList.remove("hidden");
  document.getElementById("result").innerHTML = "";
  document.getElementById("startBtn").disabled = true;

  // Timer starten
  clearInterval(timerInt);
  timerInt = setInterval(updateTimer, 1000);
  
  // Erste Aufgabe anzeigen
  showTask();
}

function showTask() {
  if (current >= tasks.length) {
    finishExam();
    return;
  }
  
  const task = tasks[current];
  document.getElementById("task").innerHTML =
    `<b>Aufgabe ${current+1}/${TASKS_TOTAL}</b><br>${task.text}`;
  document.getElementById("answer").value = "";
  
  // Fokus setzen
  setTimeout(() => document.getElementById("answer").focus(), 100);
}

function saveAnswer() {
  const answerInput = document.getElementById("answer");
  const v = parseNum(answerInput.value);
  
  if (isNaN(v)) return;
  
  const task = tasks[current];
  if (!task || typeof task.sol === 'undefined') return;
  
  // Toleranz f√ºr Gleitkommazahlen
  const tolerance = Math.max(0.05, Math.abs(task.sol) * 0.01);
  
  if (Math.abs(v - task.sol) <= tolerance) {
    points += POINTS_PER_TASK;
  }
}

function nextTask() {
  saveAnswer();
  current++;
  
  if (current < TASKS_TOTAL) {
    showTask();
  } else {
    finishExam();
  }
}

function finishExam() {
  const pin = prompt("Lehrer-PIN eingeben (Demo: 1234):");
  if (pin !== TEACHER_PIN) {
    alert("Falsche PIN - Pr√ºfung kann nicht abgeschlossen werden.");
    
    // Reset-UI
    document.getElementById("answerArea").classList.add("hidden");
    document.getElementById("timer").classList.add("hidden");
    document.getElementById("startBtn").disabled = false;
    running = false;
    clearInterval(timerInt);
    
    return;
  }

  // Letzte Aufgabe auswerten
  if (current < TASKS_TOTAL) {
    saveAnswer();
  }

  // Timer stoppen
  clearInterval(timerInt);
  running = false;

  // Note berechnen
  const pct = Math.round(points / TOTAL_POINTS * 100);
  let note = "3";
  if (pct >= 92) note = "1";
  else if (pct >= 80) note = "2";
  else if (pct >= 67) note = "3";
  else if (pct >= 50) note = "4";
  else note = "5";

  // UI aktualisieren
  document.getElementById("answerArea").classList.add("hidden");
  document.getElementById("result").innerHTML =
    `Punkte: <b>${points}/${TOTAL_POINTS}</b> (${pct}%)<br>Trainingsergebnis: <b>Note ${note}</b>`;
  
  // Button wieder aktivieren
  document.getElementById("startBtn").disabled = false;
}

/* =====================
   TIMER
===================== */
function updateTimer() {
  if (!running) return;
  
  timeLeft--;
  const m = Math.floor(timeLeft/60);
  const s = String(timeLeft%60).padStart(2,"0");
  document.getElementById("timer").innerText = `‚è± ${m}:${s}`;
  
  if (timeLeft <= 0) {
    finishExam();
  }
}

/* =====================
   EVENTS
===================== */
document.addEventListener("DOMContentLoaded", function() {
  const startBtn = document.getElementById("startBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  
  if (startBtn) {
    startBtn.addEventListener("click", startExam);
  }
  
  if (nextBtn) {
    nextBtn.addEventListener("click", nextTask);
  }
  
  if (finishBtn) {
    finishBtn.addEventListener("click", finishExam);
  }
  
  // Enter-Taste f√ºr Antwort
  const answerInput = document.getElementById("answer");
  if (answerInput) {
    answerInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        nextTask();
      }
    });
  }
});
</script>

</body>
</html>
