<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">

<!-- üì± Mobile Optimierung -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mathe Pr√ºfung ‚Äì BOA / BBR ‚≠ê</title>

<!-- ZENTRALER AUFGABENPOOL -->
<script src="pool.js"></script>

<style>
html, body {
  overflow: hidden;
  touch-action: manipulation;
}

* {
  box-sizing: border-box;
  touch-action: manipulation;
}

body {
  font-family: system-ui, Arial, sans-serif;
  background: #e9e9e9;
  margin: 0;
  padding: 12px;
}

h1 {
  text-align: center;
  font-size: clamp(1.3rem, 4vw, 2rem);
  margin-bottom: 10px;
}

#topbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
}

select, button, label {
  font-size: 1rem;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #999;
}

button {
  background: #1976d2;
  color: white;
  border: none;
}

button:active {
  background: #0d47a1;
}

#timer {
  width: 100%;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
  color: darkred;
}

#card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-width: 900px;
  margin: auto;
}

#task {
  font-size: clamp(1.1rem, 4vw, 1.4rem);
  margin-bottom: 14px;
}

#answerArea {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

input {
  font-size: 1.3rem;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}

.hidden { display: none; }

#navButtons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

#navButtons button {
  flex: 1;
}

#result {
  font-size: 1.3rem;
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}

/* üì± Extra Optimierung f√ºr sehr kleine Displays */
@media (max-width: 480px) {
  h1 { font-size: 1.3rem; }
  #task { font-size: 1.15rem; }
}
</style>
</head>

<body>

<h1>üìù Mathematik ‚Äì Pr√ºfungsmodus (Note 4)</h1>

<div id="topbar">
  <select id="level" onchange="toggleStarOption()">
    <option value="boa">BOA</option>
    <option value="bbr">BBR</option>
  </select>

  <label id="starBox" class="hidden">
    <input type="checkbox" id="stars"> ‚≠ê Stern-Aufgaben
  </label>

  <button id="startBtn">Pr√ºfung starten</button>
  <div id="timer" class="hidden"></div>
</div>

<div id="card">
  <div id="task">Noch keine Pr√ºfung gestartet.</div>

  <div id="answerArea" class="hidden">
    <input type="text" id="answer"
           inputmode="decimal"
           placeholder="Antwort eingeben">
    <div id="navButtons">
      <button id="nextBtn">Weiter</button>
      <button id="finishBtn">Abgeben</button>
    </div>
  </div>

  <div id="result"></div>
</div>

<script>
/* =======================
   KONFIG
======================= */
const EXAM_TIME = 90 * 60;        // 90 Minuten
const TASKS_TOTAL = 10;
const POINTS_PER_TASK = 3;
const PASS_POINTS = 15;           // Note-4-Training (50%)
// ‚ö†Ô∏è WICHTIG: Diese PIN ist im Quellcode sichtbar!
// F√ºr echten Einsatz sollte die PIN serverseitig validiert werden.
const TEACHER_PIN = "1234";       // ‚ö†Ô∏è NUR ZU DEMONSTRATIONSZWECKEN

/* =======================
   DOM (robust f√ºr iPad/Safari)
======================= */
const levelEl = document.getElementById("level");
const starBoxEl = document.getElementById("starBox");
const starsEl = document.getElementById("stars");
const startBtnEl = document.getElementById("startBtn");
const timerEl = document.getElementById("timer");
const taskEl = document.getElementById("task");
const answerAreaEl = document.getElementById("answerArea");
const answerEl = document.getElementById("answer");
const nextBtnEl = document.getElementById("nextBtn");
const finishBtnEl = document.getElementById("finishBtn");
const resultEl = document.getElementById("result");

/* =======================
   STATE
======================= */
let timeLeft = 0;
let timerInt = null;
let tasks = [];
let current = 0;
let points = 0;
let examRunning = false;

/* =======================
   HELPERS
======================= */
function toggleStarOption() {
  // Stern-Option nur bei BBR sichtbar; bei BOA zus√§tzlich deaktivieren
  const isBBR = levelEl.value === "bbr";
  starBoxEl.classList.toggle("hidden", !isBBR);
  if (!isBBR) starsEl.checked = false;
}

/* =======================
   PR√úFUNG ‚Äì NUTZT ZENTRALE pool.js
======================= */
function startExam() {
  // ‚ùå ENTFERNT: Fullscreen-Aufruf, der im iFrame Probleme macht
  // Unterricht-sicher: KEIN Fullscreen mehr, da iFrame-Kompatibilit√§t

  tasks = [];
  current = 0;
  points = 0;
  timeLeft = EXAM_TIME;
  examRunning = true;

  const lvl = levelEl.value;

  // üîê OPTIONALER SICHERHEITS-CHECK:
  // Falls jemand vor Start BBR ‚Üí BOA umgestellt hat,
  // erzwingen wir: BOA bekommt NIE Stern-Aufgaben
  if (lvl !== "bbr") {
    starsEl.checked = false;
  }

  const useStars = (lvl === "bbr") && starsEl.checked; // BOA niemals Stern-Aufgaben

  // AUFGABEN √úBER ZENTRALE getTask() GENERIEREN
  for (let i = 0; i < TASKS_TOTAL; i++) {
    const task = getTask({
      mode: "exam",
      level: lvl,
      stars: useStars,
      index: i
    });
    
    tasks.push({
      text: task.text,
      sol: task.sol,
      star: task.star || false
    });
  }
  
  // ‚≠ê UI-Zustand korrekt setzen (Checkbox sichtbar / unsichtbar)
  toggleStarOption();

  // Steuerelemente sperren
  levelEl.disabled = true;
  starsEl.disabled = true;

  timerEl.classList.remove("hidden");
  answerAreaEl.classList.remove("hidden");
  resultEl.innerHTML = "";

  clearInterval(timerInt);
  timerInt = setInterval(updateTimer, 1000);

  // Jetzt erst Aufgabe anzeigen
  showTask();
}

function showTask() {
  const starMark = tasks[current].star ? " ‚≠ê" : "";
  taskEl.innerHTML = `<b>Aufgabe ${current + 1}/10${starMark}</b><br>${tasks[current].text}`;
  answerEl.value = "";

  // Fokus-Zwang (Touch)
  setTimeout(() => answerEl.focus(), 200);
}

function saveCurrentAnswer() {
  // Keine Eingabe -> einfach keine Punkte (kein Alert im Unterricht, damit ruhig bleibt)
  const v = parseFloat(answerEl.value.replace(",", "."));
  if (!isNaN(v) && Math.abs(v - tasks[current].sol) < 0.05) {
    points += POINTS_PER_TASK;
  }
}

function saveAndNext() {
  if (!examRunning) return;

  saveCurrentAnswer();
  current++;

  if (current < TASKS_TOTAL) {
    showTask();
  } else {
    finishExam(); // PIN-Abgabe
  }
}

function finishExam() {
  if (!examRunning) return;

  const pin = prompt("Lehrer-PIN eingeben (Demo: 1234):");
  if (pin !== TEACHER_PIN) {
    alert("Falsche PIN - Pr√ºfung kann nicht abgeschlossen werden.");
    return;
  }

  // üî¥ WICHTIG: letzte Aufgabe sicher auswerten
  if (current < TASKS_TOTAL) {
    saveCurrentAnswer();
  }

  clearInterval(timerInt);
  timerInt = null;

  examRunning = false;
  timeLeft = 0;

  answerAreaEl.classList.add("hidden");

  const res = points >= PASS_POINTS
    ? "‚úÖ BESTANDEN"
    : "‚ùå NICHT BESTANDEN";

  resultEl.innerHTML =
    `Punkte: <b>${points} / ${TASKS_TOTAL * POINTS_PER_TASK}</b><br>${res}`;

  levelEl.disabled = false;
  starsEl.disabled = false;

  // ‚ùå ENTFERNT: exitFullscreen, da kein Fullscreen mehr
  
  toggleStarOption();
}

/* =======================
   TIMER
======================= */
function updateTimer() {
  if (!examRunning) return;

  timeLeft--;
  const m = Math.floor(timeLeft / 60);
  const s = (timeLeft % 60).toString().padStart(2, "0");
  timerEl.innerText = `‚è± ${m}:${s}`;

  if (timeLeft <= 0) {
    // Zeit ist um: Unterricht-sicher -> Lehrer-PIN zum Beenden
    finishExam();
  }
}

/* =======================
   VERLASSEN-WARNUNG (nur wenn Pr√ºfung l√§uft)
======================= */
window.addEventListener("beforeunload", function (e) {
  if (examRunning) {
    e.preventDefault();
    e.returnValue = "Der Test l√§uft noch. Bitte zuerst abgeben.";
  }
});

/* =======================
   EVENTS (statt inline onclick -> robust)
======================= */
startBtnEl.addEventListener("click", startExam);
nextBtnEl.addEventListener("click", saveAndNext);
finishBtnEl.addEventListener("click", finishExam);

// Init
toggleStarOption();
</script>

</body>
</html>
